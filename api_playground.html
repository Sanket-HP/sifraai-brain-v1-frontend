<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIFRA AI | API Playground</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        sifra: {
                            bg: '#020617', // Slate 950
                            panel: '#0f172a', // Slate 900
                            border: '#1e293b', // Slate 800
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                            success: '#10b981',
                            error: '#ef4444',
                            warn: '#f59e0b'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-nav {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Code Input Styling */
        .code-input {
            background-color: #0f172a; 
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #1e293b;
        }
        .code-input:focus {
            border-color: #06b6d4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        /* JSON Syntax Highlighting */
        .json-key { color: #06b6d4; }
        .json-string { color: #a5f3fc; }
        .json-number { color: #f472b6; }
        .json-boolean { color: #c084fc; }
        .json-null { color: #94a3b8; }
        
        /* Particle Background */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-sifra-bg text-slate-200 font-sans min-h-screen flex flex-col relative overflow-x-hidden bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">

    <!-- Background Animation -->
    <canvas id="bg-canvas"></canvas>
    <div class="fixed top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-600/5 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/5 rounded-full blur-[120px] pointer-events-none"></div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-nav w-full px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold font-orbitron text-sm shadow-lg shadow-cyan-500/20">S</div>
            <a href="index.html" class="text-lg font-orbitron font-bold text-white tracking-widest hover:text-cyan-400 transition-colors">SIFRA<span class="text-cyan-500">.AI</span></a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-10 opacity-0 transition-opacity duration-700" id="mainContent">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="px-2 py-1 rounded bg-green-500/10 border border-green-500/20 text-green-400 text-[10px] font-mono tracking-wider flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> LIVE ENVIRONMENT</span>
                <span class="h-px w-8 bg-slate-800"></span>
            </div>
            <h1 class="text-3xl md:text-4xl font-orbitron font-bold text-white mb-2">API PLAYGROUND</h1>
            <p class="text-slate-400 text-sm max-w-2xl">Execute real-time requests against the SIFRA Neural Engine. These requests connect directly to the live Gemini API models.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            
            <!-- Left Panel: Request Configuration (5 cols) -->
            <div class="lg:col-span-5 flex flex-col gap-4">
                
                <!-- Endpoint Selector -->
                <div class="glass-panel p-5 rounded-xl">
                    <label class="text-xs font-mono text-slate-500 uppercase tracking-wider block mb-3">Endpoint Configuration</label>
                    
                    <!-- API Key Input -->
                    <div class="mb-4">
                        <label class="text-[10px] font-mono text-slate-500 uppercase tracking-wider block mb-1">API Key</label>
                        <input type="password" id="apiKeyInput" class="w-full bg-slate-900 border border-slate-700 text-slate-300 text-xs font-mono rounded px-3 py-2 focus:outline-none focus:border-cyan-500 placeholder-slate-600" placeholder="Paste your Gemini API Key here">
                    </div>

                    <div class="flex gap-2 mb-4">
                        <select id="methodSelect" class="bg-slate-900 border border-slate-700 text-white text-xs font-mono rounded px-3 py-2 focus:outline-none focus:border-cyan-500">
                            <option value="POST" selected>POST</option>
                            <option value="GET">GET</option>
                        </select>
                        <select id="endpointSelect" class="flex-grow bg-slate-900 border border-slate-700 text-slate-300 text-xs font-mono rounded px-3 py-2 focus:outline-none focus:border-cyan-500" onchange="loadPreset()">
                            <option value="generateContent">/models/gemini-2.5-flash:generateContent</option>
                            <option value="predictImage">/models/imagen-4.0:predict</option>
                        </select>
                    </div>

                    <!-- Params/Body Toggle -->
                    <div class="flex border-b border-slate-800 mb-4">
                        <button class="text-xs font-medium text-cyan-400 border-b-2 border-cyan-400 pb-2 px-4">Body</button>
                        <button class="text-xs font-medium text-slate-500 pb-2 px-4 hover:text-slate-300 transition-colors">Headers</button>
                    </div>

                    <!-- Editor Area -->
                    <div class="relative group">
                        <textarea id="requestBody" class="code-input w-full h-64 rounded-lg p-4 text-xs resize-none" spellcheck="false" placeholder="// Select an endpoint to load schema..."></textarea>
                        <div class="absolute bottom-3 right-3 text-[10px] text-slate-600 pointer-events-none">JSON</div>
                    </div>
                </div>

                <!-- Action Button -->
                <button onclick="sendRequest()" id="sendBtn" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold font-orbitron tracking-widest rounded-xl transition-all shadow-lg shadow-cyan-900/20 border border-cyan-400/20 flex items-center justify-center gap-3 group">
                    <span>EXECUTE REQUEST</span>
                    <i class="fas fa-paper-plane group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <!-- Right Panel: Response (7 cols) -->
            <div class="lg:col-span-7 flex flex-col">
                <div class="glass-panel p-1 rounded-xl flex-grow flex flex-col overflow-hidden h-full min-h-[500px]">
                    
                    <!-- Response Header -->
                    <div class="bg-slate-900/50 p-3 border-b border-slate-800 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-mono text-slate-500">STATUS:</span>
                            <span id="statusIndicator" class="text-xs font-mono text-slate-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-slate-600"></span> IDLE
                            </span>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Download Report Button -->
                            <button onclick="downloadContent('json')" title="Download JSON Report" class="text-[10px] font-mono text-cyan-400 hover:text-white transition-colors flex items-center gap-1 border border-cyan-500/30 px-2 py-1 rounded bg-slate-900/50">
                                <i class="fas fa-file-download"></i> SAVE REPORT
                            </button>
                            <span class="h-4 w-px bg-slate-700"></span>
                            <span class="text-[10px] font-mono text-slate-600">TIME: <span id="latencyDisplay" class="text-slate-400">0ms</span></span>
                            <!-- Added missing SIZE span -->
                            <span class="text-[10px] font-mono text-slate-600">SIZE: <span id="sizeDisplay" class="text-slate-400">0KB</span></span>
                        </div>
                    </div>

                    <!-- Response Body -->
                    <div class="relative flex-grow bg-[#0b101b] overflow-auto custom-scrollbar p-0">
                         <!-- Loading Overlay -->
                        <div id="loadingOverlay" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 hidden">
                             <div class="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mb-4"></div>
                             <p class="text-xs font-mono text-cyan-400 animate-pulse">TRANSMITTING TO NEURAL CORE...</p>
                        </div>

                        <!-- Code Content -->
                        <pre class="p-4 text-xs font-mono leading-relaxed"><code id="responseOutput" class="language-json text-slate-300">// Awaiting execution...</code></pre>
                        
                        <!-- Image Preview Container (Hidden by default) -->
                        <div id="imagePreviewContainer" class="hidden p-4 border-t border-slate-800 relative group">
                             <div class="flex justify-between items-center mb-2">
                                <p class="text-[10px] font-mono text-slate-500">RENDERED OUTPUT:</p>
                                <!-- Download Image Button -->
                                <button onclick="downloadContent('image')" class="text-[10px] font-mono text-white bg-cyan-600 hover:bg-cyan-500 transition-colors px-3 py-1.5 rounded flex items-center gap-2 shadow-lg shadow-cyan-900/20">
                                    <i class="fas fa-image"></i> DOWNLOAD IMAGE
                                </button>
                             </div>
                             <img id="imagePreview" src="" class="rounded-lg border border-slate-700 max-w-full h-auto" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const apiKey = ""; // The execution environment provides the key at runtime.

        // --- Particle Background Logic ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.2;
                this.vy = (Math.random() - 0.5) * 0.2;
                this.size = Math.random() * 1.5;
                this.alpha = Math.random() * 0.5;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if(this.x < 0) this.x = width;
                if(this.x > width) this.x = 0;
                if(this.y < 0) this.y = height;
                if(this.y > height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = `rgba(148, 163, 184, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        for(let i=0; i<40; i++) particles.push(new Particle());
        function animate() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => p.update());
            particles.forEach(p => p.draw());
            requestAnimationFrame(animate);
        }
        animate();

        // --- Real API Logic ---

        // Real Gemini Presets
        const presets = {
            'generateContent': {
                method: 'POST',
                url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`,
                body: {
                    "contents": [{
                        "parts": [{
                            "text": "Analyze the strategic viability of Project Alpha in 3 concise bullet points."
                        }]
                    }]
                }
            },
            'predictImage': {
                method: 'POST',
                url: `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict`,
                body: {
                    "instances": [
                        {
                            "prompt": "A futuristic command center interface with glowing cyan data streams, 8k resolution, cinematic lighting"
                        }
                    ],
                    "parameters": {
                        "sampleCount": 1
                    }
                }
            }
        };

        // Load Preset on Change
        function loadPreset() {
            const endpointKey = document.getElementById('endpointSelect').value;
            const data = presets[endpointKey];
            
            document.getElementById('methodSelect').value = data.method;
            document.getElementById('requestBody').value = JSON.stringify(data.body, null, 2);
            
            // Clear previous outputs
            document.getElementById('responseOutput').innerHTML = '// Ready to execute...';
            document.getElementById('imagePreviewContainer').classList.add('hidden');
        }

        // Initialize with default preset
        window.onload = () => {
             document.getElementById('mainContent').style.opacity = '1';
             loadPreset();
        }

        // Syntax Highlighter for JSON
        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                 json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // --- Download Logic ---
        function downloadContent(type) {
            if (type === 'json') {
                const content = document.getElementById('responseOutput').innerText;
                if (content.startsWith('//') || content.trim() === '') {
                    alert("No data available to download.");
                    return;
                }
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sifra-report-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (type === 'image') {
                const img = document.getElementById('imagePreview');
                const src = img.src;
                if (!src || src === window.location.href) {
                    alert("No image generated to download.");
                    return;
                }
                const a = document.createElement('a');
                a.href = src;
                a.download = `sifra-generated-image-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Real API Call Implementation
        async function sendRequest() {
            const btn = document.getElementById('sendBtn');
            const overlay = document.getElementById('loadingOverlay');
            const output = document.getElementById('responseOutput');
            const statusInd = document.getElementById('statusIndicator');
            const latencyDisp = document.getElementById('latencyDisplay');
            const sizeDisp = document.getElementById('sizeDisplay');
            const endpointKey = document.getElementById('endpointSelect').value;
            const imgPreviewContainer = document.getElementById('imagePreviewContainer');
            const imgPreview = document.getElementById('imagePreview');
            
            // Get API Key from input or default
            const userKey = document.getElementById('apiKeyInput').value.trim();
            const finalKey = userKey || apiKey;

            // 1. Prepare UI
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            overlay.classList.remove('hidden');
            imgPreviewContainer.classList.add('hidden');
            
            // Check for key
            if (!finalKey) {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                overlay.classList.add('hidden');
                output.innerHTML = '<span class="text-yellow-400">Error: No API Key provided. Please enter a valid Gemini API Key in the configuration panel above.</span>';
                statusInd.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500"></span> MISSING KEY';
                statusInd.className = 'text-xs font-mono flex items-center gap-2 text-yellow-400';
                return;
            }

            // 2. Parse Body
            let requestBody;
            try {
                requestBody = JSON.parse(document.getElementById('requestBody').value);
            } catch (e) {
                alert("Invalid JSON in request body");
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                overlay.classList.add('hidden');
                return;
            }

            // 3. Construct URL
            const url = `${presets[endpointKey].url}?key=${finalKey}`;
            const method = presets[endpointKey].method;

            const startTime = performance.now();

            // 4. Exponential Backoff Logic
            const fetchWithBackoff = async (url, options, retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok && retries > 0 && response.status !== 400 && response.status !== 401) {
                         // Only retry on server errors or rate limits, not bad requests
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw error;
                }
            };

            try {
                const response = await fetchWithBackoff(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                const data = await response.json();
                const jsonStr = JSON.stringify(data, null, 2);

                // 5. Update Stats
                const statusColor = response.ok ? 'bg-green-500' : 'bg-red-500';
                const statusText = response.ok ? 'text-green-400' : 'text-red-400';
                
                statusInd.innerHTML = `<span class="w-2 h-2 rounded-full ${statusColor} shadow-[0_0_10px_rgba(255,255,255,0.2)]"></span> ${response.status} ${response.statusText}`;
                statusInd.className = `text-xs font-mono flex items-center gap-2 ${statusText}`;
                
                latencyDisp.innerText = latency + 'ms';
                sizeDisp.innerText = (jsonStr.length / 1024).toFixed(2) + 'KB';

                // 6. Handle Specific Responses (Images)
                if (endpointKey === 'predictImage' && data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                    const base64 = data.predictions[0].bytesBase64Encoded;
                    imgPreview.src = `data:image/png;base64,${base64}`;
                    imgPreviewContainer.classList.remove('hidden');
                }

                // 7. Render Output
                output.innerHTML = syntaxHighlight(data);

            } catch (error) {
                console.error("API Error:", error);
                statusInd.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> ERROR`;
                statusInd.className = `text-xs font-mono flex items-center gap-2 text-red-400`;
                output.innerHTML = `<span class="text-red-400">Request Failed: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>