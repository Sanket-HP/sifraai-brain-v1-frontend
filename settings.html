<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIFRA AI | Configuration</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        sifra: {
                            bg: '#020617', 
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                            danger: '#ef4444'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .input-dark {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid #1e293b;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        .input-dark:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.15);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #06b6d4;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #06b6d4;
        }
        
        .sidebar-link {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #06b6d4;
            color: #fff;
        }
        .sidebar-link:hover:not(.active) {
            background: rgba(255, 255, 255, 0.03);
            color: #cbd5e1;
        }
    </style>
</head>
<body class="bg-[#020617] text-slate-300 font-sans min-h-screen flex flex-col relative bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">

    <!-- Background Decoration -->
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-purple-900/10 rounded-full blur-[100px] pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-cyan-900/10 rounded-full blur-[100px] pointer-events-none"></div>

    <!-- Navigation -->
    <nav class="w-full px-6 py-4 flex items-center justify-between border-b border-white/5 bg-[#020617]/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold font-orbitron text-sm shadow-lg shadow-cyan-500/20">S</div>
                <span class="text-lg font-orbitron font-bold text-white tracking-widest">SIFRA<span class="text-cyan-500">.AI</span></span>
            </div>
            <a href="home.html" class="text-xs font-mono text-slate-500 hover:text-white transition-colors flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> BACK TO DASHBOARD
            </a>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden md:block">
                <div id="navUserName" class="text-sm font-bold text-white leading-none">--</div>
                <div id="navUserPlan" class="text-[10px] font-mono text-cyan-400">LOADING...</div>
            </div>
            <div id="navAvatar" class="w-9 h-9 rounded bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-white overflow-hidden">
                --
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-grow container mx-auto px-4 py-8 max-w-6xl relative z-10">
        <h1 class="text-2xl font-orbitron font-bold text-white mb-6 flex items-center gap-3">
            <i class="fas fa-cog text-slate-500"></i> SYSTEM CONFIGURATION
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Sidebar Navigation -->
            <aside class="lg:col-span-1">
                <div class="glass-panel rounded-xl overflow-hidden sticky top-24">
                    <nav class="flex flex-col text-sm font-medium">
                        <button onclick="switchTab('general')" id="btn-general" class="sidebar-link active flex items-center gap-3 px-4 py-4 text-slate-300">
                            <i class="fas fa-user-astronaut w-5 text-center"></i> Neural Identity
                        </button>
                        <button onclick="switchTab('security')" id="btn-security" class="sidebar-link flex items-center gap-3 px-4 py-4 text-slate-400">
                            <i class="fas fa-shield-alt w-5 text-center"></i> Security Protocol
                        </button>
                        <button onclick="switchTab('billing')" id="btn-billing" class="sidebar-link flex items-center gap-3 px-4 py-4 text-slate-400">
                            <i class="fas fa-credit-card w-5 text-center"></i> Subscription Core
                        </button>
                        <button onclick="switchTab('api')" id="btn-api" class="sidebar-link flex items-center gap-3 px-4 py-4 text-slate-400">
                            <i class="fas fa-code w-5 text-center"></i> API Gateway
                        </button>
                        <div class="border-t border-white/5 my-1"></div>
                        <button onclick="logout()" class="flex items-center gap-3 px-4 py-4 text-red-400 hover:bg-red-500/10 transition-colors w-full text-left">
                            <i class="fas fa-power-off w-5 text-center"></i> Terminate Session
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- Content Area -->
            <main class="lg:col-span-3">
                
                <!-- GENERAL TAB -->
                <div id="tab-general" class="space-y-6 animate-fadeIn">
                    <div class="glass-panel rounded-xl p-6 md:p-8">
                        <h2 class="text-lg font-bold text-white mb-1">Profile Configuration</h2>
                        <p class="text-xs text-slate-500 mb-6">Manage your public identity and neural link identifiers.</p>

                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <!-- Avatar Upload -->
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-24 h-24 rounded-full bg-slate-900 border-2 border-slate-700 flex items-center justify-center relative group overflow-hidden">
                                    <img id="profileImage" src="" class="w-full h-full object-cover hidden" alt="Profile">
                                    <span id="profileInitials" class="text-2xl font-bold text-slate-500">--</span>
                                    
                                    <!-- Hover Overlay -->
                                    <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="alert('Upload feature coming in v4.3')">
                                        <i class="fas fa-camera text-white"></i>
                                    </div>
                                </div>
                                <span class="text-[10px] text-slate-500 uppercase tracking-wide">Commander Avatar</span>
                            </div>

                            <!-- Inputs -->
                            <div class="flex-grow space-y-4 w-full">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Callsign (Display Name)</label>
                                        <input type="text" id="inputName" class="w-full input-dark rounded-md px-3 py-2 text-sm font-mono focus:border-cyan-500" placeholder="ENTER_CALLSIGN">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Role / Job Title</label>
                                        <input type="text" id="inputRole" class="w-full input-dark rounded-md px-3 py-2 text-sm font-mono focus:border-purple-500" placeholder="DATA_ARCHITECT">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Neural Link (Email)</label>
                                    <div class="relative">
                                        <input type="email" id="inputEmail" class="w-full input-dark rounded-md px-3 py-2 text-sm font-mono text-slate-500 cursor-not-allowed" disabled>
                                        <i class="fas fa-lock absolute right-3 top-2.5 text-xs text-slate-600"></i>
                                    </div>
                                    <p class="text-[9px] text-slate-500 mt-1">Identity vector locked. Contact admin to change.</p>
                                </div>
                                <div class="pt-2">
                                    <button onclick="saveGeneralProfile()" id="saveGeneralBtn" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded text-xs transition-all shadow-lg shadow-cyan-500/20">
                                        SAVE CONFIGURATION
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECURITY TAB -->
                <div id="tab-security" class="space-y-6 hidden animate-fadeIn">
                    <div class="glass-panel rounded-xl p-6 md:p-8">
                        <h2 class="text-lg font-bold text-white mb-1">Security Protocols</h2>
                        <p class="text-xs text-slate-500 mb-6">Manage authentication layers and encryption keys.</p>

                        <div class="space-y-6">
                            <!-- Password Change -->
                            <div class="border border-slate-800 rounded-lg p-4 bg-slate-900/30">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-sm font-bold text-white">Access Key Rotation</h3>
                                        <p class="text-xs text-slate-500 mt-1">Send a secure link to reset your password.</p>
                                    </div>
                                    <button onclick="resetPassword()" id="resetPwdBtn" class="border border-slate-600 hover:border-slate-400 text-slate-300 hover:text-white px-4 py-2 rounded text-xs transition-all">
                                        SEND RESET LINK
                                    </button>
                                </div>
                            </div>

                            <!-- 2FA Toggle -->
                            <div class="border border-slate-800 rounded-lg p-4 bg-slate-900/30">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-sm font-bold text-white">Multi-Factor Authentication (MFA)</h3>
                                        <p class="text-xs text-slate-500 mt-1">Require neural handshake (OTP) on new device logins.</p>
                                    </div>
                                    <div class="relative inline-block w-10 h-5 align-middle select-none">
                                        <input type="checkbox" id="toggleMFA" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-700 transition-all duration-300"/>
                                        <label for="toggleMFA" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer transition-colors duration-300"></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Account -->
                            <div class="border border-red-900/30 rounded-lg p-4 bg-red-950/10">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="text-sm font-bold text-red-400">Terminate Protocol</h3>
                                        <p class="text-xs text-red-900/60 mt-1">Permanently purge all data and neural pathways.</p>
                                    </div>
                                    <button onclick="alert('Critical: Contact Support to purge data.')" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-4 py-2 rounded text-xs transition-all">
                                        DELETE ACCOUNT
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BILLING TAB -->
                <div id="tab-billing" class="space-y-6 hidden animate-fadeIn">
                    <div class="glass-panel rounded-xl p-6 md:p-8">
                        <h2 class="text-lg font-bold text-white mb-1">Resource Allocation</h2>
                        <p class="text-xs text-slate-500 mb-6">Current subscription tier and usage metrics.</p>

                        <!-- Plan Card -->
                        <div class="relative overflow-hidden rounded-xl border border-purple-500/30 bg-gradient-to-br from-purple-900/20 to-slate-900 p-6 mb-6">
                            <div class="absolute top-0 right-0 p-4">
                                <i class="fas fa-crown text-6xl text-purple-500/10 rotate-12"></i>
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-mono text-purple-400 uppercase tracking-widest mb-2">CURRENT TIER</p>
                                <h3 id="billingPlanName" class="text-3xl font-orbitron font-bold text-white">LOADING...</h3>
                                <p id="billingPlanDesc" class="text-sm text-slate-400 mt-2 max-w-md">Retrieving subscription details from the core...</p>
                                
                                <div class="mt-6 flex gap-3">
                                    <a href="subscription-page.html" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded text-xs transition-colors shadow-lg shadow-purple-500/20">
                                        UPGRADE TIER
                                    </a>
                                    <button class="text-slate-400 hover:text-white text-xs font-mono underline decoration-dotted">Manage Payment Method</button>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-900/50 rounded p-4 border border-slate-800">
                                <div class="text-[10px] text-slate-500 uppercase">Daily Executions</div>
                                <div id="usageExecutions" class="text-xl font-mono text-cyan-400 mt-1">--/--</div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-4 border border-slate-800">
                                <div class="text-[10px] text-slate-500 uppercase">Storage Used</div>
                                <div class="text-xl font-mono text-purple-400 mt-1">124 MB</div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-4 border border-slate-800">
                                <div class="text-[10px] text-slate-500 uppercase">Next Billing</div>
                                <div class="text-xl font-mono text-white mt-1">Auto-Renew</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API TAB -->
                <div id="tab-api" class="space-y-6 hidden animate-fadeIn">
                    <div class="glass-panel rounded-xl p-6 md:p-8">
                        <h2 class="text-lg font-bold text-white mb-1">API Gateway</h2>
                        <p class="text-xs text-slate-500 mb-6">Manage access keys for external programmatic access.</p>

                        <div class="bg-black/30 border border-slate-800 rounded-lg p-4 font-mono text-xs">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-slate-500 uppercase font-bold">Secret Key</label>
                                <span class="px-2 py-0.5 rounded bg-green-900/30 text-green-400 border border-green-900">ACTIVE</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" value="sifra_sk_live_8392...99a1" readonly class="w-full bg-transparent border-none text-slate-300 focus:ring-0 px-0">
                                <button onclick="navigator.clipboard.writeText('sifra_sk_live_8392...99a1')" class="text-cyan-400 hover:text-white" title="Copy"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded text-xs transition-colors border border-slate-600">
                                <i class="fas fa-plus mr-2"></i> GENERATE NEW KEY
                            </button>
                            <p class="text-[10px] text-slate-500 mt-2">Rotating keys will immediately invalidate old connections.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyBu6CIgw5njjcl9dVhNYjitSUBKE87_S6M",
            authDomain: "sifraaiweb.firebaseapp.com",
            projectId: "sifraaiweb",
            storageBucket: "sifraaiweb.firebasestorage.app",
            messagingSenderId: "927713452336",
            appId: "1:927713452336:web:f3affb6ef66091619e68f5",
            measurementId: "G-V3TXBH3GCD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserUid = null;

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid;
                await loadUserProfile(user);
            } else {
                window.location.href = 'login.html';
            }
        });

        // 1. Load User Data
        async function loadUserProfile(user) {
            // Basic Auth Info
            document.getElementById('inputEmail').value = user.email;
            document.getElementById('inputName').value = user.displayName || "";
            updateAvatar(user.displayName);

            // Firestore Info
            try {
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    
                    // General
                    if (data.callsign) document.getElementById('inputName').value = data.callsign;
                    if (data.role) document.getElementById('inputRole').value = data.role;
                    updateAvatar(data.callsign || user.email);

                    // Nav
                    document.getElementById('navUserName').innerText = (data.callsign || user.email).toUpperCase();
                    document.getElementById('navUserPlan').innerText = (data.subscriptionTier || 'RECRUIT').toUpperCase();

                    // Billing Logic
                    const tier = data.subscriptionTier || 'recruit';
                    document.getElementById('billingPlanName').innerText = tier.toUpperCase();
                    
                    if (tier === 'titan') {
                        document.getElementById('billingPlanDesc').innerText = "Unlimited processing power. Full API access. Dedicated support.";
                        document.getElementById('billingPlanName').classList.add('text-purple-400');
                    } else if (tier === 'commander') {
                        document.getElementById('billingPlanDesc').innerText = "Enhanced priority processing. 100GB secure storage.";
                        document.getElementById('billingPlanName').classList.add('text-cyan-400');
                    } else {
                        document.getElementById('billingPlanDesc').innerText = "Standard access. Limited execution threads.";
                        document.getElementById('billingPlanName').classList.add('text-slate-300');
                    }

                    // Usage
                    const usage = data.dailyUsage?.count || 0;
                    const limit = tier === 'recruit' ? 3 : 'âˆž';
                    document.getElementById('usageExecutions').innerText = `${usage} / ${limit}`;

                    // Security
                    if (data.mfaEnabled) {
                        document.getElementById('toggleMFA').checked = true;
                    }
                }
            } catch(e) {
                console.error("Error loading profile:", e);
            }
        }

        // 2. Update Avatar Helper
        function updateAvatar(name) {
            const el = document.getElementById('navAvatar');
            const lgEl = document.getElementById('profileInitials');
            const nameStr = name || "U";
            const initials = nameStr.substring(0, 2).toUpperCase();
            el.innerText = initials;
            lgEl.innerText = initials;
        }

        // 3. Save General Profile
        window.saveGeneralProfile = async () => {
            const btn = document.getElementById('saveGeneralBtn');
            const originalText = btn.innerText;
            const newName = document.getElementById('inputName').value;
            const newRole = document.getElementById('inputRole').value;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> SAVING...`;

            try {
                // Update Auth Profile
                if (auth.currentUser.displayName !== newName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                }

                // Update Firestore
                const userRef = doc(db, "users", currentUserUid);
                await updateDoc(userRef, {
                    callsign: newName,
                    role: newRole
                });

                // Update UI immediately
                updateAvatar(newName);
                document.getElementById('navUserName').innerText = newName.toUpperCase();

                btn.classList.replace('bg-cyan-600', 'bg-green-600');
                btn.innerHTML = `<i class="fas fa-check"></i> SAVED`;
                
                setTimeout(() => {
                    btn.classList.replace('bg-green-600', 'bg-cyan-600');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error(error);
                btn.innerText = "ERROR";
                setTimeout(() => { btn.disabled = false; btn.innerText = originalText; }, 2000);
            }
        };

        // 4. Password Reset
        window.resetPassword = async () => {
            const btn = document.getElementById('resetPwdBtn');
            const email = auth.currentUser.email;
            
            btn.disabled = true;
            btn.innerText = "SENDING...";

            try {
                await sendPasswordResetEmail(auth, email);
                btn.innerText = "EMAIL SENT";
                btn.classList.add('text-green-400', 'border-green-500');
            } catch (e) {
                alert("Error: " + e.message);
                btn.innerText = "RETRY";
                btn.disabled = false;
            }
        };

        // 5. MFA Toggle
        document.getElementById('toggleMFA').addEventListener('change', async (e) => {
            const isChecked = e.target.checked;
            try {
                const userRef = doc(db, "users", currentUserUid);
                await updateDoc(userRef, { mfaEnabled: isChecked });
            } catch (err) {
                console.error("MFA Toggle Error", err);
                e.target.checked = !isChecked; // Revert on fail
            }
        });

        // 6. Logout
        window.logout = async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        // Expose to window for HTML onClick
        window.switchTab = (tabId) => {
            // Hide all contents
            document.getElementById('tab-general').classList.add('hidden');
            document.getElementById('tab-security').classList.add('hidden');
            document.getElementById('tab-billing').classList.add('hidden');
            document.getElementById('tab-api').classList.add('hidden');

            // Deactivate all buttons
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active', 'text-slate-300', 'bg-white/5'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.add('text-slate-400'));

            // Activate Target
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            const btn = document.getElementById(`btn-${tabId}`);
            btn.classList.add('active', 'text-slate-300');
            btn.classList.remove('text-slate-400');
        };

    </script>
</body>
</html>