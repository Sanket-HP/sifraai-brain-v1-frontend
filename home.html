<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIFRA AI | Command Node Omega</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js (2D) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Plotly.js (3D) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        sifra: {
                            bg: '#020617', // Slate 950
                            panel: '#0f172a', // Slate 900
                            border: '#1e293b', // Slate 800
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                            success: '#10b981',
                            error: '#ef4444',
                            warn: '#f59e0b'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan': 'scan 4s linear infinite',
                        'bounce-delay': 'bounce 1s infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism & Borders */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .input-glow:focus-within {
            border-color: rgba(6, 182, 212, 0.6);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.15);
        }

        /* Chat Specific Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.5;
            overflow-x: auto;
        }
        .chat-user {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-bottom-right-radius: 0.25rem;
            color: #e2e8f0;
            margin-left: auto;
        }
        .chat-ai {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-bottom-left-radius: 0.25rem;
            color: #e2e8f0;
            margin-right: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Terminal Styling */
        .console-line { margin-bottom: 2px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; display: flex; gap: 8px; }
        .console-time { color: #64748b; min-width: 70px; }
        .log-info { color: #94a3b8; }
        .log-success { color: #34d399; }
        .log-error { color: #f87171; }
        .log-warn { color: #fbbf24; }
        .log-sys { color: #22d3ee; font-weight: bold; }

        /* Utilities */
        .tab-active { border-bottom: 2px solid #06b6d4; color: #fff; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #cbd5e1; }
        
        .chart-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; line-height: 1rem; font-family: 'JetBrains Mono', monospace; border-radius: 0.25rem; border-width: 1px; transition: all 150ms; }
        .chart-btn-active { background-color: rgb(22 78 99 / 0.5); border-color: #06b6d4; color: #67e8f9; }
        .chart-btn-inactive { background-color: #1e293b; border-color: #334155; color: #94a3b8; }
        .chart-btn-inactive:hover { background-color: #334155; color: #ffffff; }
    </style>
</head>
<body class="bg-sifra-bg text-slate-200 font-sans h-screen overflow-hidden flex selection:bg-cyan-500/30 opacity-0 transition-opacity duration-700" id="appBody">

    <!-- 1. Navigation Sidebar -->
    <aside class="w-16 lg:w-64 bg-sifra-bg border-r border-sifra-border flex flex-col z-20 transition-all duration-300">
        <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-sifra-border bg-black/20">
            <div class="relative w-8 h-8 flex items-center justify-center">
                <div class="absolute inset-0 bg-cyan-500 blur-md opacity-20 animate-pulse"></div>
                <div class="relative w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold font-orbitron text-lg shadow-lg">S</div>
            </div>
            <span class="ml-3 font-orbitron font-bold text-white tracking-widest hidden lg:block text-lg">SIFRA</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 px-2">
            <button class="w-full flex items-center gap-3 px-3 py-3 text-cyan-400 bg-cyan-500/10 rounded-lg border border-cyan-500/20 transition-all group relative overflow-hidden">
                <div class="absolute inset-0 bg-cyan-400/5 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300"></div>
                <i class="fas fa-terminal w-5 text-center"></i>
                <span class="hidden lg:block text-sm font-medium">Command Center</span>
            </button>
            <button class="w-full flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                <i class="fas fa-database w-5 text-center"></i>
                <span class="hidden lg:block text-sm font-medium">Datasets</span>
            </button>
            <button class="w-full flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                <i class="fas fa-network-wired w-5 text-center"></i>
                <span class="hidden lg:block text-sm font-medium">Integrations</span>
            </button>
            <!-- Link Settings to Profile -->
            <a href="profile.html" class="w-full flex items-center gap-3 px-3 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                <i class="fas fa-cog w-5 text-center"></i>
                <span class="hidden lg:block text-sm font-medium">Settings</span>
            </a>
        </nav>
        <div class="p-4 border-t border-sifra-border hidden lg:block bg-black/20">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-bold text-slate-500 font-orbitron">SYSTEM HEALTH</span>
                <span id="pingValue" class="text-[10px] font-mono text-slate-400">--ms</span>
            </div>
            <div class="flex items-center gap-3 p-2 rounded bg-slate-900/50 border border-white/5">
                <div class="relative">
                    <div id="statusPulse" class="absolute inset-0 rounded-full bg-red-500 animate-ping opacity-75"></div>
                    <div id="statusDot" class="relative w-2 h-2 rounded-full bg-red-500"></div>
                </div>
                <div>
                    <div id="statusText" class="text-xs font-bold text-slate-300">Offline</div>
                    <div id="statusSub" class="text-[10px] text-slate-500">Backend Unreachable</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
        <header class="h-16 border-b border-sifra-border flex items-center justify-between px-6 bg-sifra-bg/80 backdrop-blur-md z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-orbitron font-bold text-white flex items-center gap-2">
                    <span class="text-cyan-500">//</span> EXECUTION_NODE_01
                </h1>
                <span class="px-2 py-0.5 rounded text-[10px] bg-slate-800 text-slate-400 border border-slate-700 font-mono">v4.2.1-LLM</span>
            </div>
            <div class="flex items-center gap-6">
                <div class="hidden md:flex items-center gap-2 text-xs font-mono text-slate-400">
                    <span id="planBadge" class="px-2 py-0.5 rounded bg-slate-800 text-slate-300 border border-slate-600 uppercase font-bold">LOADING...</span>
                    <span class="w-[1px] h-3 bg-slate-700"></span>
                    <span>MEM: <span class="text-cyan-400">42%</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <button class="text-slate-400 hover:text-white transition"><i class="fas fa-bell"></i></button>
                    <!-- Link Avatar to Profile -->
                    <a href="profile.html" class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-500 to-purple-500 p-[2px] block cursor-pointer hover:scale-105 transition-transform overflow-hidden relative">
                        <img id="headerAvatar" src="" class="w-full h-full rounded-full object-cover hidden" alt="User">
                        <div id="headerInitials" class="w-full h-full rounded-full bg-slate-900 flex items-center justify-center text-xs font-bold text-white">--</div>
                    </a>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 scroll-smooth">
            
            <!-- Input & Config -->
            <div class="lg:col-span-4 flex flex-col h-full overflow-hidden">
                <div class="glass-panel rounded-xl flex flex-col h-full border-t-2 border-t-cyan-500 overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center shrink-0">
                        <h2 class="font-orbitron text-sm font-bold text-cyan-400 flex items-center gap-2">
                            <i class="fas fa-microchip"></i> INPUT PARAMETERS
                        </h2>
                        <i class="fas fa-wifi text-xs text-slate-500" id="inputStatusIcon"></i>
                    </div>
                    <div class="p-5 flex-1 flex flex-col gap-5 overflow-y-auto">
                        <div class="space-y-2 shrink-0">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">1. Operation Mode</label>
                            <div class="relative group">
                                <select id="goal" onchange="toggleInputPanel(this.value)" class="w-full bg-slate-950 border border-slate-700 text-sm text-white rounded-md px-4 py-3 appearance-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all cursor-pointer font-mono">
                                    <option value="analyze">üîç Deep Analysis (Exploratory)</option>
                                    <option value="visualize">üìä Interactive Visualization (Dashboards)</option>
                                    <option value="forecast">üìà Predictive Forecasting (Time-Series)</option>
                                    <option value="anomaly">‚ö†Ô∏è Anomaly Detection (Outliers)</option>
                                    <option value="insights">üí° Strategic Insights (Narrative)</option>
                                    <option value="model">ü§ñ AutoML Training (Classification)</option>
                                    <option value="llm">üß† Create Synthetic LLM</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-cyan-500">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                        <div id="standardInputs" class="contents">
                            <div class="space-y-2 flex-1 flex flex-col min-h-[300px]">
                                <div class="flex justify-between items-end shrink-0">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">2. Data Stream</label>
                                    <div class="flex gap-2">
                                        <button onclick="document.getElementById('csvUpload').click()" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-white px-2 py-1 rounded border border-slate-600 transition flex items-center gap-1">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                        <button onclick="loadSampleData()" class="text-[10px] bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 px-2 py-1 rounded border border-cyan-800 transition">Sample</button>
                                        <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleFileUpload(this, 'rawData')">
                                    </div>
                                </div>
                                <div class="relative flex-1 group w-full">
                                    <div class="absolute -inset-[1px] bg-gradient-to-br from-cyan-500/20 to-purple-600/20 rounded-lg opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <textarea id="rawData" class="relative w-full h-full bg-slate-950 border border-slate-700 rounded-lg p-3 font-mono text-xs text-slate-300 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all resize-none leading-relaxed input-glow custom-scrollbar" placeholder="// ENTER CSV DATA..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div id="llmInputs" class="hidden flex-1 flex flex-col gap-5">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">2. LLM Persona</label>
                                <div class="relative group">
                                    <select id="llmPersona" class="w-full bg-slate-950 border border-slate-700 text-xs text-white rounded-md px-3 py-2 appearance-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition-all cursor-pointer font-mono">
                                        <option value="assistant">General Assistant</option>
                                        <option value="teacher">Teacher / Explainer</option>
                                        <option value="analyst">Data Analyst</option>
                                        <option value="expert">Business Domain Expert</option>
                                        <option value="coder">Code Specialist</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-purple-500"><i class="fas fa-chevron-down text-xs"></i></div>
                                </div>
                            </div>
                            <div class="space-y-2 flex-1 flex flex-col">
                                <div class="flex justify-between items-end shrink-0">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">3. Knowledge Base (RAG)</label>
                                    <div class="flex gap-2">
                                         <button onclick="document.getElementById('llmUpload').click()" class="text-[10px] bg-slate-800 hover:bg-slate-700 text-white px-2 py-1 rounded border border-slate-600 transition flex items-center gap-1"><i class="fas fa-upload"></i> Upload Context</button>
                                        <input type="file" id="llmUpload" accept=".txt,.md,.csv,.json" class="hidden" onchange="handleFileUpload(this, 'llmKnowledge')">
                                    </div>
                                </div>
                                <div class="relative flex-1 group">
                                    <div class="absolute -inset-[1px] bg-gradient-to-br from-purple-500/20 to-pink-600/20 rounded-lg opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <textarea id="llmKnowledge" class="relative w-full h-full bg-slate-950 border border-slate-700 rounded-lg p-3 font-mono text-xs text-slate-300 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition-all resize-none leading-relaxed input-glow custom-scrollbar" placeholder="// Paste documents, notes, or domain knowledge here..."></textarea>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">4. Behavior & Tone</label>
                                <div class="relative group">
                                    <div class="absolute -inset-[1px] bg-gradient-to-r from-purple-500/20 to-cyan-600/20 rounded-md opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <input id="llmBehavior" type="text" class="relative w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-xs text-white focus:border-purple-500 outline-none font-mono transition-all" placeholder="e.g. Strict, Professional, Sarcastic, Concise">
                                </div>
                            </div>
                        </div>
                        <div class="shrink-0 pt-2">
                            <button onclick="runSifra()" id="runBtn" class="w-full relative group overflow-hidden rounded-md p-[1px] shadow-[0_0_20px_rgba(6,182,212,0.15)]">
                                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 transition-all duration-300 animate-gradient-x"></div>
                                <div class="relative bg-slate-900 group-hover:bg-opacity-0 transition-all duration-300 rounded-md py-4 px-4 flex items-center justify-center gap-3">
                                    <i class="fas fa-bolt text-cyan-400 group-hover:text-white text-lg"></i>
                                    <span class="font-orbitron font-bold text-white tracking-widest text-sm">INITIALIZE ENGINE</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output & Console -->
            <div class="lg:col-span-8 flex flex-col gap-6 h-full overflow-hidden">
                <!-- Console -->
                <!-- UPDATED HEIGHT: h-64 (256px) -->
                <div class="glass-panel rounded-xl h-64 flex flex-col overflow-hidden border-l-4 border-l-purple-500">
                    <div class="bg-black/60 px-3 py-1.5 flex items-center justify-between border-b border-white/5">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-terminal text-purple-400 text-xs"></i>
                            <span class="text-[10px] font-bold text-slate-400 font-mono uppercase">System Log Stream</span>
                        </div>
                        <div class="flex gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                            <div class="w-2 h-2 rounded-full bg-slate-700"></div>
                        </div>
                    </div>
                    <div id="consoleLog" class="flex-1 bg-[#05050a] p-3 overflow-y-auto font-mono text-xs space-y-1 custom-scrollbar scroll-smooth relative">
                        <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 pointer-events-none bg-[length:100%_2px,3px_100%]"></div>
                        <div class="console-line"><span class="console-time">[init]</span><span class="log-sys">KERNEL_V4 loaded. Memory checks passed.</span></div>
                        <div class="console-line"><span class="console-time">[net]</span><span class="log-info">Establish connection to [::1]:8000...</span></div>
                    </div>
                </div>

                <!-- Results Viewer -->
                <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden relative min-h-[500px]">
                    <div class="bg-slate-900/80 backdrop-blur border-b border-white/5 px-4 flex justify-between items-center h-12 overflow-x-auto">
                        <div class="flex gap-6 h-full shrink-0">
                            <button onclick="switchTab('visuals')" id="tab-visuals" class="tab-active h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-chart-line"></i> VISUALS</button>
                            <button onclick="switchTab('stats')" id="tab-stats" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-table"></i> STATS</button>
                            <button onclick="switchTab('insights')" id="tab-insights" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-lightbulb"></i> INSIGHTS</button>
                            <button onclick="switchTab('explain')" id="tab-explain" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-robot"></i> AI EXPLAIN</button>
                            <button onclick="switchTab('model')" id="tab-model" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-cubes"></i> MODEL</button>
                            <button onclick="switchTab('llm')" id="tab-llm" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-brain"></i> LLM</button>
                            <button onclick="switchTab('json')" id="tab-json" class="tab-inactive h-full text-xs font-bold font-orbitron flex items-center gap-2 transition-colors"><i class="fas fa-code"></i> RAW JSON</button>
                        </div>
                        <div id="processingIndicator" class="hidden flex items-center gap-2 shrink-0">
                            <span class="text-[10px] text-cyan-400 font-mono animate-pulse">PROCESSING_DATA_CHUNKS...</span>
                            <i class="fas fa-circle-notch fa-spin text-cyan-500 text-xs"></i>
                        </div>
                    </div>

                    <div class="flex-1 bg-slate-950/50 relative overflow-hidden">
                        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-700 z-0">
                            <i class="fas fa-cube text-6xl mb-4 opacity-20"></i>
                            <p class="text-sm font-mono opacity-50">AWAITING_INPUT_STREAM</p>
                        </div>

                        <div id="view-visuals" class="absolute inset-0 p-6 overflow-y-auto hidden z-10 custom-scrollbar flex flex-col gap-6">
                             <div class="flex items-center gap-3 w-fit bg-slate-900/80 p-2 rounded-lg border border-slate-700">
                                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Visualization Type:</label>
                                <div class="relative">
                                    <select id="chartTypeSelector" onchange="updateChartType(this.value)" class="bg-slate-800 border border-slate-600 text-xs text-cyan-400 rounded px-3 py-1.5 appearance-none pr-8 focus:border-cyan-500 focus:outline-none cursor-pointer font-mono uppercase hover:bg-slate-700 transition-colors">
                                        <option value="line">Line Chart</option>
                                        <option value="bar">Bar Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="doughnut">Doughnut Chart</option>
                                        <option value="radar">Radar Chart</option>
                                        <option value="polarArea">Polar Area</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-2.5 top-2.5 text-[10px] text-slate-500 pointer-events-none"></i>
                                </div>
                                <div class="w-[1px] h-6 bg-slate-600"></div>
                                <button onclick="toggle3DView()" id="btn-3d" class="text-[10px] font-bold text-slate-400 bg-slate-800 border border-slate-600 px-3 py-1.5 rounded hover:text-white hover:border-cyan-500 transition-colors flex items-center gap-2">
                                    <i class="fas fa-cube"></i> 3D View
                                </button>
                                <button onclick="downloadVisual()" class="text-[10px] font-bold text-slate-400 bg-slate-800 border border-slate-600 px-3 py-1.5 rounded hover:text-white hover:border-green-500 transition-colors flex items-center gap-2">
                                    <i class="fas fa-download"></i> Download Visual
                                </button>
                            </div>
                            <div class="flex-1 bg-slate-900/50 rounded-lg border border-white/5 p-4 relative min-h-[300px]">
                                <h4 class="text-[10px] font-bold text-slate-500 mb-2 uppercase absolute top-4 left-4 z-10">Main Visualization</h4>
                                <canvas id="mainChart"></canvas>
                                <div id="chart3d" class="w-full h-full hidden"></div>
                            </div>
                            <div class="w-full bg-slate-900/50 rounded-lg border border-white/5 p-4">
                                <h4 class="text-[10px] font-bold text-slate-500 mb-4 uppercase">Correlation Heatmap</h4>
                                <div id="heatmapGrid" class="grid gap-1 w-full overflow-x-auto"></div>
                            </div>
                        </div>

                        <div id="view-stats" class="absolute inset-0 p-6 overflow-y-auto hidden z-10 custom-scrollbar">
                            <div class="w-full bg-slate-900 rounded-lg border border-slate-800 overflow-hidden">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-800 text-[10px] uppercase text-slate-400 font-bold">
                                        <tr><th class="p-3 border-b border-slate-700">Column</th><th class="p-3 border-b border-slate-700">Type</th><th class="p-3 border-b border-slate-700">Min</th><th class="p-3 border-b border-slate-700">Max</th><th class="p-3 border-b border-slate-700">Mean</th><th class="p-3 border-b border-slate-700">Missing</th></tr>
                                    </thead>
                                    <tbody id="statsTableBody" class="text-xs font-mono text-slate-300 divide-y divide-slate-800"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="view-insights" class="absolute inset-0 p-6 overflow-y-auto hidden z-10 custom-scrollbar">
                            <div id="insightsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <div id="view-explain" class="absolute inset-0 p-6 overflow-y-auto hidden z-10 custom-scrollbar">
                            <div class="space-y-6">
                                <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4 relative overflow-hidden group">
                                    <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <h4 class="text-xs font-bold text-cyan-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fas fa-brain"></i> Cognitive Process</h4>
                                    <div id="explainSteps" class="space-y-3 relative z-10"></div>
                                </div>
                                <div id="aiExplainTab" class="bg-slate-900/50 border border-slate-700 rounded-lg p-4 relative overflow-hidden group">
                                    <div class="absolute inset-0 bg-gradient-to-r from-purple-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                                    <h4 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-align-left"></i> AI Explanation</h4>
                                    <p id="aiExplainText" class="text-sm text-slate-300 leading-relaxed font-light relative z-10 whitespace-pre-line"></p>
                                </div>
                            </div>
                        </div>

                        <div id="view-model" class="absolute inset-0 p-6 overflow-y-auto hidden z-10 custom-scrollbar">
                            <div class="flex flex-col gap-6">
                                <!-- 1. Improved Metrics Grid -->
                                <div id="modelMetrics" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-2">
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 shadow-lg shadow-cyan-950/20 hover:border-cyan-500/40 transition-all">
                                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">ML Task</p>
                                        <p id="mlTask" class="text-lg font-mono text-cyan-400 mt-1">-</p>
                                    </div>
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 shadow-lg shadow-purple-950/20 hover:border-purple-500/40 transition-all overflow-hidden">
                                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Best Model</p>
                                        <p id="bestModel" class="text-lg font-mono text-purple-400 mt-1 truncate" title="-">-</p>
                                    </div>
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 shadow-lg shadow-blue-950/20 hover:border-blue-500/40 transition-all overflow-hidden">
                                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Best Score</p>
                                        <p id="bestScore" class="text-lg font-mono text-blue-400 mt-1 truncate" title="-">-</p>
                                    </div>
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 shadow-lg shadow-green-950/20 hover:border-green-500/40 transition-all">
                                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Accuracy / RMSE</p>
                                        <p id="accuracy" class="text-lg font-mono text-green-400 mt-1">-</p>
                                    </div>
                                </div>

                                <!-- 2. Model Summary Panel -->
                                <div class="relative rounded-xl bg-slate-950/70 border border-slate-800 p-5 mt-4 shadow-inner shadow-black/40">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-blue-500"></div>
                                    <h3 class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-3 flex items-center gap-2">
                                        <i class="fas fa-file-code text-purple-400"></i> Model Summary
                                    </h3>
                                    <pre id="modelSummary" class="text-[11px] leading-relaxed text-green-400 font-mono overflow-auto custom-scrollbar h-40 p-3 bg-slate-900/40 rounded-xl border border-slate-800">
// Training pending‚Ä¶ select AutoML and run engine.
                                    </pre>
                                </div>

                                <div id="testModelSection" class="hidden">
                                    <!-- 3. Model Artifacts Download -->
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4 flex justify-between items-center mt-6 shadow-lg shadow-blue-950/20">
                                        <div>
                                            <h3 class="text-sm font-bold text-white">Model Artifact</h3>
                                            <p class="text-[11px] text-slate-500">Download serialized model (.pkl)</p>
                                        </div>
                                        <a id="downloadModelBtn" href="#" class="bg-gradient-to-r from-blue-600 to-cyan-500 hover:brightness-125 transition text-white font-semibold text-xs px-4 py-2 rounded-lg shadow-md flex items-center gap-2">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>

                                    <!-- 4. Redesigned Prediction Playground -->
                                    <div class="bg-slate-900/60 border border-slate-700 rounded-xl overflow-hidden mt-5 shadow-xl shadow-purple-950/30">
                                        <!-- Header -->
                                        <div class="bg-slate-800/60 border-b border-slate-700 px-4 py-3 flex justify-between items-center">
                                            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                                                <i class="fas fa-microscope text-purple-400"></i> Prediction Playground
                                            </h3>
                                            <button onclick="autofillSampleData()" class="text-[10px] text-cyan-400 hover:text-white transition flex items-center gap-1">
                                                <i class="fas fa-magic"></i> Auto-fill
                                            </button>
                                        </div>
                                        <!-- Body -->
                                        <div class="p-5 grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            <!-- Left: Inputs -->
                                            <div id="featureInputsContainer" class="lg:col-span-2 grid grid-cols-2 gap-4 max-h-60 overflow-auto custom-scrollbar pr-1"></div>
                                            <!-- Right: Output -->
                                            <div class="lg:col-span-1 bg-slate-950 border border-slate-800 rounded-xl p-4 flex flex-col justify-between shadow-md">
                                                <div>
                                                    <span class="text-[10px] text-slate-500 uppercase font-bold">Prediction</span>
                                                    <div id="testResult" class="text-2xl font-mono text-cyan-400 mt-3 break-all">--</div>
                                                </div>
                                                <button onclick="runPrediction()" class="mt-4 w-full bg-gradient-to-r from-purple-600 to-cyan-600 text-white font-bold text-xs py-3 rounded-lg shadow-lg hover:from-purple-500 hover:to-cyan-500 transition-all active:scale-95">
                                                    Run Prediction
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. LLM Tab (UPGRADED PRO VERSION) -->
                        <div id="view-llm" class="absolute inset-0 p-0 overflow-hidden hidden z-10 flex">
                            <!-- Sidebar -->
                            <div class="w-64 bg-slate-900/80 border-r border-slate-800 p-4 flex flex-col gap-4 shrink-0 overflow-y-auto custom-scrollbar">
                                <h3 class="text-xs font-bold text-cyan-400 font-orbitron uppercase mb-2">LLM Metrics</h3>
                                <div class="space-y-3 text-xs font-mono text-slate-400">
                                    <div><span class="block text-slate-500">Persona</span><span id="llmMetaPersona" class="text-white">-</span></div>
                                    <div><span class="block text-slate-500">LLM ID</span><span id="llmMetaID" class="text-white truncate" title="-">-</span></div>
                                    <div><span class="block text-slate-500">Knowledge Nodes</span><span id="llmMetaNodes" class="text-purple-400">-</span></div>
                                    <div><span class="block text-slate-500">Vector Memory</span><span id="llmMetaMemory" class="text-cyan-400">-</span></div>
                                    <div><span class="block text-slate-500">Temperature</span><span id="llmMetaTemp" class="text-warn">-</span></div>
                                </div>
                                <div class="mt-auto pt-4 border-t border-slate-800">
                                    <button onclick="downloadLLM()" id="dlLLMBtn" class="w-full bg-slate-800 hover:bg-slate-700 text-white text-xs py-2 rounded border border-slate-600 transition"><i class="fas fa-download mr-2"></i> Save Package</button>
                                </div>
                            </div>

                            <!-- Chat Area -->
                            <div class="flex-1 flex flex-col bg-slate-950/30 relative">
                                <!-- Chat History: Added overflow-x-auto for horizontal scrolling -->
                                <div id="chatHistory" class="flex-1 p-4 overflow-y-auto overflow-x-auto space-y-4 custom-scrollbar scroll-smooth pb-24">
                                    <!-- Messages go here -->
                                </div>
                                <div class="p-4 bg-slate-900/90 border-t border-slate-800 absolute bottom-0 w-full z-20">
                                    <div class="relative">
                                        <textarea id="chatInput" rows="1" class="w-full bg-slate-950 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none resize-none custom-scrollbar" placeholder="Send a message to the Synthetic LLM..."></textarea>
                                        <button onclick="sendChatMessage()" class="absolute right-2 bottom-2 p-2 text-purple-400 hover:text-white transition rounded-lg"><i class="fas fa-paper-plane"></i></button>
                                    </div>
                                    <div class="text-[10px] text-slate-600 mt-1 px-2 flex justify-between">
                                        <span>Enter to send, Shift+Enter for new line</span>
                                        <span id="llmStatusIndicator" class="hidden text-cyan-400"><i class="fas fa-circle-notch fa-spin mr-1"></i> Processing...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="view-json" class="absolute inset-0 p-0 overflow-hidden hidden z-10">
                            <pre id="jsonContent" class="w-full h-full p-6 text-xs font-mono text-cyan-100 overflow-auto custom-scrollbar"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Application Logic -->
    <script>
        // --- Configuration & Global State ---
        const BACKEND_URL = "https://sifra-backend-brain-v1.onrender.com";
        let backendOnline = false;
        let chartInstance = null;
        let uploadedDataset = [];
        let uploadedHeaders = [];
        let lastAnalysisResult = null;
        let currentChartType = 'line';
        let trainedModelHex = null;
        let trainedPreprocessorHex = null; // Added
        let trainedModelFeatureCount = 0;
        let trainedModelFeatureNames = [];
        let trainedModelScaler = null;
        let llmKnowledgeBase = [];
        let is3DMode = false;
        
        let currentLLMPersona = "assistant";
        window.SIFRA_LLM_PACKAGE = null; // New global for LLM package

        // DOM Elements
        const consoleLog = document.getElementById('consoleLog');
        const processingIndicator = document.getElementById('processingIndicator');
        const emptyState = document.getElementById('emptyState');
        const runBtn = document.getElementById('runBtn');
        const statusDot = document.getElementById('statusDot');
        const statusPulse = document.getElementById('statusPulse');
        const statusText = document.getElementById('statusText');
        const statusSub = document.getElementById('statusSub');
        const pingValue = document.getElementById('pingValue');

        // --- 1. System Initialization & Networking ---
        async function checkBackend() {
            const start = Date.now();
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const res = await fetch(`${BACKEND_URL}/health`, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (res.ok) {
                    const latency = Date.now() - start;
                    setOnlineState(latency);
                } else {
                    throw new Error("Health check failed");
                }
            } catch (e) {
                setOfflineState();
            }
        }

        function setOnlineState(latency) {
            backendOnline = true;
            statusDot.className = "relative w-2 h-2 rounded-full bg-green-500";
            statusPulse.className = "absolute inset-0 rounded-full bg-green-500 animate-ping opacity-75";
            statusText.innerText = "Online";
            statusText.className = "text-xs font-bold text-green-400";
            statusSub.innerText = "HDP-FusionNet Active";
            pingValue.innerText = `${latency}ms`;
        }

        function setOfflineState() {
            backendOnline = false;
            statusDot.className = "relative w-2 h-2 rounded-full bg-red-500";
            statusPulse.className = "absolute inset-0 rounded-full bg-red-500 animate-ping opacity-75";
            statusText.innerText = "Offline";
            statusText.className = "text-xs font-bold text-red-400";
            statusSub.innerText = "Simulation Mode Ready";
            pingValue.innerText = "--ms";
        }

        logToConsole("Initializing UI subsystems...", "sys");
        setInterval(checkBackend, 5000); // Check every 5s
        checkBackend();

        // Input handling for LLM chat
        document.getElementById('chatInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // --- 2. Data Handling & UI Logic ---
        function toggleInputPanel(mode) {
            const std = document.getElementById('standardInputs');
            const llm = document.getElementById('llmInputs');
            if(mode === 'llm') {
                std.classList.add('hidden');
                std.classList.remove('contents');
                llm.classList.remove('hidden');
                logToConsole("Switched to LLM Creation Mode.", "info");
            } else {
                std.classList.remove('hidden');
                std.classList.add('contents');
                llm.classList.add('hidden');
            }
        }

        function switchTab(tabName) {
            ['visuals', 'stats', 'insights', 'explain', 'model', 'llm', 'json'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.replace('tab-inactive', 'tab-active');
            if(tabName === 'llm') {
                // Auto scroll to bottom when switching to LLM
                const history = document.getElementById('chatHistory');
                if(history) history.scrollTop = history.scrollHeight;
            }
        }

        function logToConsole(msg, type) {
            const div = document.createElement('div');
            div.className = "console-line";
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            div.innerHTML = `<span class="console-time">[${time}]</span><span class="log-${type}">${msg}</span>`;
            consoleLog.appendChild(div);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function loadSampleData() {
            const sample = `Date,Revenue,Expenses,Users
2023-01-01,15000,12000,540
2023-01-02,18500,11500,620
2023-01-03,14200,10000,480
2023-01-04,19800,13000,710
2023-01-05,22000,12500,850
2023-01-06,21500,12200,810
2023-01-07,17000,11800,600
2023-01-08,24500,14000,920
2023-01-09,38000,15000,1400
2023-01-10,23000,12800,880`;
            document.getElementById('rawData').value = sample;
            logToConsole("Sample Dataset [Revenue_Q1] loaded into buffer.", "info");
        }

        function handleFileUpload(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            logToConsole(`Reading file stream: ${file.name}...`, "info");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                document.getElementById(targetId).value = content;
                logToConsole("File buffer read successfully.", "success");
                if (targetId === 'llmKnowledge') {
                    const parsed = parseCSV(content);
                    if (parsed && parsed.data.length > 0) {
                        logToConsole("Converting dataset to knowledge format...", "info");
                        try {
                            const res = await fetch(`${BACKEND_URL}/dataset_to_knowledge`, {
                                method: 'POST',
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ csv_text: content })
                            });
                            if (res.ok) {
                                const json = await res.json();
                                if (json.knowledge_sentences) {
                                    llmKnowledgeBase = json.knowledge_sentences;
                                    document.getElementById('llmKnowledge').value = llmKnowledgeBase.join('\n');
                                    logToConsole("Knowledge base generated from dataset.", "success");
                                }
                            } else {
                                logToConsole("Backend conversion failed. Using raw text.", "warn");
                            }
                        } catch (err) {
                            logToConsole("Error during knowledge conversion: " + err.message, "error");
                        }
                    }
                }
            };
            reader.onerror = () => logToConsole("File read error.", "error");
            reader.readAsText(file);
        }

        function parseCSV(raw) {
            try {
                const lines = raw.trim().split('\n');
                if (lines.length < 2) throw new Error("CSV requires header and at least one row");
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',');
                    if (row.length <= 1 && row[0] === '') continue;
                    const parsedRow = row.map(cell => {
                        const val = cell.trim();
                        return isNaN(Number(val)) ? val : Number(val);
                    });
                    data.push(parsedRow);
                }
                uploadedHeaders = headers;
                uploadedDataset = data;
                return { headers, data };
            } catch (e) {
                logToConsole(`CSV Parse Error: ${e.message}`, "error");
                return null;
            }
        }

        // --- 3. Core Execution Router ---
        async function runSifra() {
            // Check Usage Limit First
            if (window.checkLimit) {
                const allowed = await window.checkLimit();
                if (!allowed) return;
            }

            const goal = document.getElementById('goal').value;
            let success = false;

            if (goal === 'llm') {
                await generateLLM();
            } else if (goal === 'model') {
                await generateModel();
            } else {
                await executeStandardAnalysis(goal);
            }
        }

        // --- 4. LLM Generation Logic ---
        async function generateLLM() {
            const persona = document.getElementById('llmPersona').value;
            const knowledge = document.getElementById('llmKnowledge').value;
            const behavior = document.getElementById('llmBehavior').value;
            if (!knowledge.trim()) {
                logToConsole("LLM Error: Knowledge base is empty.", "error");
                alert("Please provide text for the knowledge base.");
                return;
            }
            currentLLMPersona = persona;
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            logToConsole(`[init] Initializing LLM Kernel (${persona})...`, "sys");
            await new Promise(r => setTimeout(r, 800));
            logToConsole(`[vectorizer] Parsing ${knowledge.length} characters of knowledge...`, "info");
            await new Promise(r => setTimeout(r, 800));
            logToConsole(`[memory] Compiling vector embeddings...`, "info");
            await new Promise(r => setTimeout(r, 800));
            logToConsole(`[compile] Building behavioral model: "${behavior}"...`, "info");
            
            // Set Sidebar Defaults
            document.getElementById('llmMetaPersona').innerText = persona.toUpperCase();
            document.getElementById('llmMetaTemp').innerText = "0.7";
            document.getElementById('llmMetaNodes').innerText = Math.floor(knowledge.length / 50); 
            document.getElementById('llmMetaMemory').innerText = (knowledge.length * 0.004).toFixed(2) + " KB";

            if (backendOnline) {
                try {
                    const payload = {
                        config: { persona, behavior, temperature: 0.7 },
                        documents: (llmKnowledgeBase.length > 0) ? llmKnowledgeBase : knowledge.split('\n')
                    };
                    const res = await fetch(`${BACKEND_URL}/create_llm`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    
                    if(!res.ok) throw new Error("Failed to create LLM");
                    const result = await res.json();

                    // üî• NEW FIX ‚Äî unwrap nested "result" properly.
                    let r = result;
                    // Unwrap wrappers
                    while (r.result) {
                        r = r.result;
                    }
                    if (r.llm_package) {
                        // SAFEGUARD: If backend returned a stringified JSON, parse it first
                        let rawPkg = r.llm_package;
                        if (typeof rawPkg === 'string') {
                            try {
                                rawPkg = JSON.parse(rawPkg);
                            } catch(e) {
                                console.error("Failed to parse llm_package string:", e);
                            }
                        }
                        window.SIFRA_LLM_PACKAGE = rawPkg;
                        document.getElementById('llmMetaID').innerText = rawPkg.llm_id || "sifra-synth";
                        document.getElementById('llmMetaID').title = rawPkg.llm_id || "sifra-synth";
                    } else {
                        console.warn("‚ö†Ô∏è LLM package missing in backend response", r);
                    }
                    logToConsole(`[success] SIFRA Synthetic LLM Created on Backend.`, "success");
                    if (window.incrementUsage) window.incrementUsage(); // Count Usage
                } catch(e) {
                    logToConsole(`[warn] Backend sync failed: ${e.message}`, "warn");
                }
            } else {
                 // Offline fallback
                 window.SIFRA_LLM_PACKAGE = { llm_id: "offline-sim", config: { persona } };
                 document.getElementById('llmMetaID').innerText = "offline-sim";
                 if (window.incrementUsage) window.incrementUsage(); // Count Usage (even for offline sim)
            }
            
            logToConsole(`[success] SIFRA Synthetic LLM Ready.`, "success");
            switchTab('llm');
            
            // Clear Chat History
            const history = document.getElementById('chatHistory');
            history.innerHTML = '';
            renderLLMMessage(`System: LLM Kernel initialized. Persona: ${persona}. Ready.`);

            btn.disabled = false;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            renderUserMessage(msg);
            input.value = "";
            input.style.height = 'auto'; // Reset height

            // Loading State
            const indicator = document.getElementById('llmStatusIndicator');
            indicator.classList.remove('hidden');
            
            // Create temp loading bubble
            const history = document.getElementById('chatHistory');
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex justify-start w-full";
            loadingDiv.id = loadingId;
            loadingDiv.innerHTML = `
                <div class="chat-bubble chat-ai">
                    <span class="text-xs text-purple-300 font-bold mb-1 block">SIFRA</span>
                    <div class="flex gap-1 mt-1">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>`;
            history.appendChild(loadingDiv);
            history.scrollTop = history.scrollHeight;

            try {
                let replyText = "‚ö†Ô∏è No response generated by LLM.";
                
                if (backendOnline) {
                    let pkgToSend = window.SIFRA_LLM_PACKAGE;
                    
                    // Double-check: If it's a string, parse it
                    if (typeof pkgToSend === 'string') {
                        try {
                            pkgToSend = JSON.parse(pkgToSend);
                        } catch(e) {
                            throw new Error("Corrupt LLM Package: Unable to parse JSON string.");
                        }
                    }

                    // Final check
                    if (!pkgToSend || typeof pkgToSend !== 'object') {
                         throw new Error("Invalid LLM Package format. Please recreate the model.");
                    }

                    const payload = {
                        prompt: msg,
                        llm_package: pkgToSend
                    };
                    
                    const res = await fetch(`${BACKEND_URL}/llm_inference`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error("LLM Inference failed");
                    
                    const data = await res.json();
                    // Handle nested response structure
                    // üî• Support ANY backend wrapper
                    let d = data;
                    while (d.response || d.result) {
                        d = d.response || d.result;
                    }
                    if (d.reply) replyText = d.reply;
                } else {
                    // Offline Simulation
                    await new Promise(r => setTimeout(r, 1500));
                    replyText = "[Offline Simulation] I received your message: " + msg;
                }

                // Remove loading indicator
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();

                renderLLMMessage(replyText);

            } catch (e) {
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                renderLLMMessage(`Error: ${e.message}`, true);
            } finally {
                indicator.classList.add('hidden');
            }
        }

        function renderUserMessage(text) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = "flex justify-end w-full";
            div.innerHTML = `
                <div class="chat-bubble chat-user">
                    <div class="text-xs whitespace-pre-wrap">${text}</div>
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function renderLLMMessage(text, isError = false) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = "flex justify-start w-full";
            
            const bubbleClass = isError ? "bg-red-900/50 border border-red-500 text-red-200" : "chat-ai";
            
            div.innerHTML = `
                <div class="chat-bubble ${bubbleClass}">
                    ${!isError ? '<span class="text-xs text-purple-300 font-bold mb-1 block">SIFRA</span>' : ''}
                    <div class="text-xs whitespace-pre-wrap leading-relaxed">${text}</div>
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function downloadLLM() {
            logToConsole("Packaging LLM Model...", "info");
            setTimeout(() => {
                const blob = new Blob([JSON.stringify(window.SIFRA_LLM_PACKAGE || {}, null, 2)], { type: "application/json" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "SIFRA_LLM_Package.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                logToConsole("LLM Package downloaded.", "success");
            }, 1000);
        }

        // --- 5. ML Model Logic ---
        async function generateModel() {
            const rawText = document.getElementById('rawData').value;

            if(!rawText.trim()) { 
                logToConsole("Cannot generate model: No dataset loaded.", "error");
                return; 
            }

            if (!uploadedDataset || uploadedDataset.length === 0) {
                parseCSV(rawText);
            }

            document.getElementById("mlTask").innerText = "Processing...";
            document.getElementById("bestModel").innerText = "Processing...";
            document.getElementById("bestScore").innerText = "Processing...";
            document.getElementById("accuracy").innerText = "Processing...";

            document.getElementById("testModelSection").classList.add("hidden");

            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            processingIndicator.classList.remove('hidden');
            switchTab('model');

            logToConsole("Initiating Model Training & Serialization...", "sys");

            // ‚úÖ FIXED PAYLOAD
            const payload = {
                mode: "automl",
                dataset: uploadedDataset
            };

            console.log("FINAL PAYLOAD SENT:", payload); // DEBUG LINE

            try {
                let data;

                if (backendOnline) {
                    const res = await fetch(`${BACKEND_URL}/create_model`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if(!res.ok) throw new Error("Server failed to create model.");

                    data = await res.json();
                } else {
                    await new Promise(r => setTimeout(r, 2000));
                    // Updated mock data structure to match new expectations
                    data = {
                        result: {
                            task: "Classification",
                            best_model: "RandomForestClassifier",
                            best_score: "0.945",
                            best_accuracy: "94.5%",
                            model_summary: "RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)\n\nPrecision: 0.94\nRecall: 0.93\nF1-Score: 0.94",
                            model_hex: "4d5a90000300000004000000ffff0000b8000000000000004000000000000000",
                            feature_count: 3, 
                            feature_names: ["Expenses", "Marketing_Spend", "Competitor_Index"], 
                            scaler: { mean: [15000, 500, 30], scale: [5000, 100, 10] }
                        }
                    };
                }

                logToConsole(`[DEBUG] Payload Received. Keys: ${Object.keys(data).join(', ')}`, "sys");

                // üî• FIX: Fully unwrap nested result objects
                let r = data;
                while (r.result) {
                    r = r.result;
                }
                logToConsole(`[DEBUG] Final Unwrapped Result Keys: ${Object.keys(r).join(', ')}`, "sys");

                document.getElementById("mlTask").innerText = r.task || r.ml_task || "-";
                
                // Truncate Best Model Name if needed
                document.getElementById("bestModel").innerText = r.best_model || "-";
                document.getElementById("bestModel").title = r.best_model || "-";

                // Format score to 4 decimal places
                let score = r.best_score;
                if (score && !isNaN(parseFloat(score))) {
                    score = parseFloat(score).toFixed(4);
                }
                document.getElementById("bestScore").innerText = score || "-";
                document.getElementById("bestScore").title = r.best_score || "-";

                document.getElementById("modelSummary").innerText = r.model_summary || "No summary";

                // Logic to update accuracy
                const accVal = r.best_accuracy || r.accuracy;
                const accEl = document.getElementById("accuracy");
                
                if (accVal && typeof accVal === "object") {
                    accEl.innerHTML = `
                        RMSE: ${accVal.rmse}<br>
                        MAE: ${accVal.mae}<br>
                        MAPE: ${accVal.mape}
                    `;
                    accEl.className = "text-[10px] text-green-400 font-mono leading-tight"; // Adjust styling for multiline
                } else {
                    accEl.innerText = accVal || "-";
                    accEl.className = "text-sm text-green-400 font-mono";
                }

                logToConsole(`Training Complete. Best Model: ${r.best_model}`, "success");

                // OPTIONAL ‚Äî ADD ANIMATION WHEN MODEL IS TRAINED
                document.getElementById("modelMetrics").classList.add("animate-pulse");
                setTimeout(() => {
                    document.getElementById("modelMetrics").classList.remove("animate-pulse");
                }, 1200);

                const hex = r.model_hex || r.model_bytes_hex;

                if (hex) {
                    trainedModelHex = hex;
                    trainedPreprocessorHex = r.preprocessor_hex || null; // Added
                    
                    // FALLBACK LOGIC FOR FEATURES
                    if (r.feature_names && r.feature_names.length > 0) {
                        trainedModelFeatureNames = r.feature_names;
                    } else if (uploadedHeaders && uploadedHeaders.length > 1) {
                        // Assumption: Target is the last column
                        trainedModelFeatureNames = uploadedHeaders.slice(0, -1);
                        logToConsole("‚ö†Ô∏è Backend didn't return feature names. Using dataset columns (excluding last) as fallback.", "warn");
                    } else {
                        // Fallback to generic names if absolutely nothing
                        trainedModelFeatureNames = [];
                    }

                    trainedModelFeatureCount = r.feature_count || trainedModelFeatureNames.length || 0;
                    trainedModelScaler = r.scaler;

                    renderFeatureInputs(trainedModelFeatureNames, trainedModelFeatureCount);

                    document.getElementById("testModelSection").classList.remove("hidden");

                    const byteArray = new Uint8Array(hex.match(/.{1,2}/g).map(x => parseInt(x, 16)));
                    const blob = new Blob([byteArray], { type: "application/octet-stream" });
                    const url = URL.createObjectURL(blob);

                    const dl = document.getElementById("downloadModelBtn");
                    dl.href = url;
                    dl.download = "SIFRA_Trained_Model.pkl";
                } else {
                    logToConsole("Model trained, but no serialized model returned for download/inference.", "warn");
                }

                if (window.incrementUsage) window.incrementUsage(); // Count Usage

            } catch (e) {
                logToConsole("Training failed: " + e.message, "error");
            } finally {
                btn.disabled = false;
                processingIndicator.classList.add('hidden');
            }
        }

        function renderFeatureInputs(names, count) {
            const container = document.getElementById('featureInputsContainer');
            container.innerHTML = "";
            
            // Safety check
            if ((!names || names.length === 0) && (!count || count === 0)) {
                container.innerHTML = '<div class="col-span-2 text-xs text-slate-500 italic p-2">No input features detected.</div>';
                return;
            }

            const featureNames = (names && names.length > 0) ? names : Array.from({length: count}, (_, i) => `Feature ${i + 1}`);
            
            featureNames.forEach((name, index) => {
                const div = document.createElement('div');
                div.className = "flex flex-col gap-1";
                div.innerHTML = `<label class="text-[10px] text-slate-400 font-mono truncate" title="${name}">${name}</label><input type="text" class="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs text-white focus:border-purple-500 outline-none font-mono prediction-input" data-index="${index}" placeholder="0.0">`;
                container.appendChild(div);
            });
        }

        function autofillSampleData() {
            const inputs = document.querySelectorAll('.prediction-input');
            inputs.forEach(input => {
                const val = (Math.random() * 1000).toFixed(2);
                input.value = val;
            });
            logToConsole("Sample values auto-filled.", "info");
        }

        async function runPrediction() {
            if (!trainedModelHex) {
                logToConsole("Error: No trained model found.", "error");
                return;
            }
            const inputs = document.querySelectorAll('.prediction-input');
            const features = [];
            let missing = false;
            inputs.forEach(input => {
                const val = parseFloat(input.value.trim());
                if (isNaN(val)) {
                    missing = true;
                    input.classList.add('border-red-500');
                } else {
                    input.classList.remove('border-red-500');
                    features.push(val);
                }
            });
            if (missing) {
                logToConsole("Please enter valid numeric values for all features.", "warn");
                return;
            }
            if (trainedModelFeatureCount > 0 && features.length !== trainedModelFeatureCount) {
                const msg = `Error: Model expects ${trainedModelFeatureCount} features, got ${features.length}.`;
                logToConsole(msg, "error");
                alert(msg);
                return;
            }
            let finalFeatures = features;
            if (trainedModelScaler && trainedModelScaler.mean && trainedModelScaler.scale) {
                try {
                    finalFeatures = features.map((val, i) => {
                        const m = trainedModelScaler.mean[i] || 0;
                        const s = trainedModelScaler.scale[i] || 1;
                        return (val - m) / s;
                    });
                } catch (e) {
                    console.warn("Scaling failed, using raw inputs.");
                }
            }
            const resultSpan = document.getElementById('testResult');
            resultSpan.innerText = "Predicting...";
            try {
                if (backendOnline) {
                    const payload = { 
                        model_hex: trainedModelHex, 
                        preprocessor_hex: (typeof trainedPreprocessorHex !== 'undefined') ? trainedPreprocessorHex : null, // SAFE extraction
                        features: finalFeatures 
                    };
                    const res = await fetch(`${BACKEND_URL}/predict`, {
                        method: 'POST',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if(!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.detail || "Prediction API failed");
                    }
                    const data = await res.json();
                    resultSpan.innerText = `Result: ${data.prediction}`;
                    logToConsole(`Prediction: ${data.prediction}`, "success");
                } else {
                    await new Promise(r => setTimeout(r, 600));
                    const mockPred = Math.random() > 0.5 ? "Class 1 (Probability: 89%)" : "Class 0 (Probability: 72%)";
                    resultSpan.innerText = mockPred;
                    logToConsole(`Simulated Prediction: ${mockPred}`, "info");
                }
            } catch(e) {
                resultSpan.innerText = "Error";
                logToConsole("Prediction Error: " + e.message, "error");
            }
        }

        // --- 6. Standard Data Analysis Logic ---
        async function executeStandardAnalysis(goal) {
            const rawText = document.getElementById('rawData').value;
            if (!rawText.trim()) {
                logToConsole("Input buffer empty. Aborting.", "error");
                alert("Please provide data.");
                return;
            }
            runBtn.disabled = true;
            runBtn.classList.add('opacity-50', 'cursor-not-allowed');
            processingIndicator.classList.remove('hidden');
            emptyState.classList.add('hidden');
            switchTab('visuals');
            logToConsole(`Starting Sequence: [${goal.toUpperCase()}]`, "sys");
            logToConsole("Parsing input tensors...", "info");
            const parsed = parseCSV(rawText);
            if (!parsed) { resetUIState(); return; }
            logToConsole(`Loaded ${parsed.data.length} records. Dimensions: ${parsed.headers.length}x${parsed.data.length}`, "success");
            const payload = { mode: goal, columns: parsed.headers, data: parsed.data };
            let responseData;
            try {
                if (backendOnline) {
                    logToConsole("Dispatching to Backend API...", "warn");
                    const res = await fetch(`${BACKEND_URL}/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(`API Error ${res.status}`);
                    responseData = await res.json();
                } else {
                    logToConsole("Backend Offline. Engaging Simulation Engine.", "warn");
                    await new Promise(r => setTimeout(r, 1200)); 
                    responseData = generateMockResponse(goal, parsed);
                }
                lastAnalysisResult = { parsed, goal, response: responseData };
                logToConsole("Computation Complete. Rendering Output.", "success");
                renderRawJSON(responseData);
                renderSummaryStats(parsed);
                renderInsights(responseData, goal);
                renderVisuals(); 
                renderExplanation(responseData);
                if (window.incrementUsage) window.incrementUsage(); // Count Usage
            } catch (e) {
                logToConsole(`Execution Failure: ${e.message}`, "error");
            } finally {
                resetUIState();
            }
        }

        function resetUIState() {
            runBtn.disabled = false;
            runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            processingIndicator.classList.add('hidden');
        }

        // --- Visual Functions ---
        function toggle3DView() {
            is3DMode = !is3DMode;
            const btn = document.getElementById('btn-3d');
            
            if (is3DMode) {
                btn.classList.add('text-cyan-400', 'border-cyan-500');
                btn.classList.remove('text-slate-400', 'border-slate-600');
                // Force render
                renderVisuals();
            } else {
                btn.classList.remove('text-cyan-400', 'border-cyan-500');
                btn.classList.add('text-slate-400', 'border-slate-600');
                // Force render
                renderVisuals();
            }
        }

        function renderVisuals() {
            if (!lastAnalysisResult) return;
            const { parsed, goal, response } = lastAnalysisResult;
            
            // Handle view switching
            const canvas2d = document.getElementById('mainChart');
            const div3d = document.getElementById('chart3d');
            
            if (is3DMode) {
                canvas2d.classList.add('hidden');
                div3d.classList.remove('hidden');
                render3DChart(parsed);
            } else {
                canvas2d.classList.remove('hidden');
                div3d.classList.add('hidden');
                render2DChart(parsed, goal, response);
            }

            // Always render heatmap
            renderCorrelationHeatmap(parsed);
        }

        function render3DChart(parsed) {
            const numericIndices = parsed.headers.map((h, i) => typeof parsed.data[0][i] === 'number' ? i : -1).filter(i => i !== -1);
            
            if (numericIndices.length < 3) {
                document.getElementById('chart3d').innerHTML = '<div class="flex items-center justify-center h-full text-slate-500 text-xs">Need at least 3 numeric columns for 3D visualization.</div>';
                return;
            }

            const xIdx = numericIndices[0];
            const yIdx = numericIndices[1];
            const zIdx = numericIndices[2];

            const xData = parsed.data.map(row => row[xIdx]);
            const yData = parsed.data.map(row => row[yIdx]);
            const zData = parsed.data.map(row => row[zIdx]);

            const trace = {
                x: xData,
                y: yData,
                z: zData,
                mode: 'markers',
                marker: {
                    size: 4,
                    color: zData,
                    colorscale: 'Viridis',
                    opacity: 0.8
                },
                type: 'scatter3d'
            };

            const layout = {
                margin: { l: 0, r: 0, b: 0, t: 0 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                scene: {
                    xaxis: { title: parsed.headers[xIdx], color: '#94a3b8' },
                    yaxis: { title: parsed.headers[yIdx], color: '#94a3b8' },
                    zaxis: { title: parsed.headers[zIdx], color: '#94a3b8' },
                }
            };

            Plotly.newPlot('chart3d', [trace], layout, {displayModeBar: false});
        }

        function render2DChart(parsed, goal, response) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const numericIndices = parsed.headers.map((h, i) => typeof parsed.data[0][i] === 'number' ? i : -1).filter(i => i !== -1);
            if (numericIndices.length === 0) return;
            const labelCol = parsed.headers[0];
            const dataColIndex = numericIndices[0]; 
            const dataLabel = parsed.headers[dataColIndex];
            const labels = parsed.data.map(row => row[0]);
            const values = parsed.data.map(row => row[dataColIndex]);
            let backgroundAlpha = 0.2;
            let borderColor = '#06b6d4'; 
            if (currentChartType === 'bar') borderColor = '#8b5cf6'; 
            if (currentChartType === 'radar') borderColor = '#ec4899'; 
            if (['doughnut', 'polarArea', 'pie'].includes(currentChartType)) {
                const palette = ['#06b6d4', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b'];
                borderColor = palette; 
                backgroundAlpha = 0.7;
            }
            let chartData = { labels: labels, datasets: [{ label: dataLabel, data: values, borderColor: borderColor, backgroundColor: (Array.isArray(borderColor)) ? borderColor : `rgba(${currentChartType === 'bar' ? '139, 92, 246' : '6, 182, 212'}, ${backgroundAlpha})`, borderWidth: 2, tension: 0.4, fill: true, pointRadius: 3 }] };
            if (goal === 'forecast' && response.predictions && (currentChartType === 'line' || currentChartType === 'bar')) {
                const lastVal = values[values.length - 1];
                const predValues = response.predictions.map(p => p.value);
                const extendedLabels = [...labels, ...response.predictions.map((_, i) => `Forecast +${i+1}`)];
                const paddedActual = [...values, ...Array(predValues.length).fill(null)];
                const paddedForecast = [...Array(values.length - 1).fill(null), lastVal, ...predValues];
                chartData = { labels: extendedLabels, datasets: [{ label: 'Historical', data: paddedActual, borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.2)', tension: 0.4 }, { label: 'Forecast', data: paddedForecast, borderColor: '#a855f7', borderDash: [5, 5], tension: 0.4 }] };
            }
            chartInstance = new Chart(ctx, { type: currentChartType, data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'Orbitron' } } } }, scales: (['doughnut', 'polarArea', 'pie', 'radar'].includes(currentChartType)) ? {} : { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }, x: { grid: { display: false }, ticks: { color: '#64748b' } } } } });
        }

        function downloadVisual() {
            if (is3DMode) {
                Plotly.downloadImage('chart3d', {format: 'png', filename: 'sifra_3d_viz'});
            } else {
                if (chartInstance) {
                    const link = document.createElement('a');
                    link.download = 'sifra_chart_viz.png';
                    link.href = document.getElementById('mainChart').toDataURL('image/png', 1.0);
                    link.click();
                } else {
                    logToConsole("No chart available to download.", "warn");
                }
            }
        }

        // --- Rendering Functions ---
        function renderRawJSON(json) { document.getElementById('jsonContent').textContent = JSON.stringify(json, null, 2); }
        function renderSummaryStats(parsed) {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            parsed.headers.forEach((header, idx) => {
                const colData = parsed.data.map(row => row[idx]);
                const numericData = colData.filter(v => typeof v === 'number');
                const isNumeric = numericData.length > colData.length / 2;
                let min = '-', max = '-', mean = '-';
                if (isNumeric && numericData.length > 0) {
                    min = Math.min(...numericData).toFixed(2);
                    max = Math.max(...numericData).toFixed(2);
                    const sum = numericData.reduce((a, b) => a + b, 0);
                    mean = (sum / numericData.length).toFixed(2);
                }
                const missing = colData.filter(v => v === null || v === '' || v === undefined).length;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                tr.innerHTML = `<td class="p-3 border-b border-slate-800 font-bold text-slate-300">${header}</td><td class="p-3 border-b border-slate-800 text-cyan-500">${isNumeric ? 'Numeric' : 'String'}</td><td class="p-3 border-b border-slate-800">${min}</td><td class="p-3 border-b border-slate-800">${max}</td><td class="p-3 border-b border-slate-800">${mean}</td><td class="p-3 border-b border-slate-800 ${missing > 0 ? 'text-red-400' : 'text-slate-500'}">${missing}</td>`;
                tbody.appendChild(tr);
            });
        }
        function renderCorrelationHeatmap(parsed) {
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            const headers = parsed.headers;
            const numericIndices = headers.map((h, i) => typeof parsed.data[0][i] === 'number' ? i : -1).filter(i => i !== -1);
            const numCols = numericIndices.length;
            if (numCols < 2) { grid.innerHTML = '<p class="text-xs text-slate-500 p-2">Not enough numeric columns for correlation.</p>'; return; }
            grid.style.gridTemplateColumns = `auto repeat(${numCols}, 1fr)`;
            grid.appendChild(createCell("", "transparent"));
            numericIndices.forEach(idx => { grid.appendChild(createCell(headers[idx].substring(0, 8), "transparent", "text-slate-400 font-bold text-[10px]")); });
            numericIndices.forEach(rowIdx => {
                grid.appendChild(createCell(headers[rowIdx].substring(0, 8), "transparent", "text-slate-400 font-bold text-[10px]"));
                numericIndices.forEach(colIdx => {
                    let corr = 0;
                    if (rowIdx === colIdx) corr = 1.0;
                    else { const diff = Math.abs(rowIdx - colIdx); corr = 1 - (diff * 0.2); if (corr < -1) corr = -1; }
                    const intensity = Math.abs(corr);
                    let color = `rgba(6, 182, 212, ${intensity * 0.8})`; 
                    if (corr < 0) color = `rgba(248, 113, 113, ${intensity * 0.8})`; 
                    grid.appendChild(createCell(corr.toFixed(2), color, "text-white text-[10px]"));
                });
            });
        }
        function createCell(text, bg, extraClasses = "") { const div = document.createElement('div'); div.className = `flex items-center justify-center h-10 rounded text-xs ${extraClasses}`; div.style.backgroundColor = bg; div.innerText = text; return div; }
        function renderInsights(response, goal) {
            const container = document.getElementById('insightsContainer');
            container.innerHTML = '';
            let insights = response.insights || ["Data processed successfully."];
            insights.forEach(text => {
                const card = document.createElement('div');
                card.className = "bg-slate-900 border border-slate-700 p-4 rounded-lg flex gap-4 hover:border-cyan-500/50 transition duration-300";
                card.innerHTML = `<div class="w-10 h-10 rounded-full bg-cyan-900/30 flex items-center justify-center shrink-0"><i class="fas fa-lightbulb text-cyan-400"></i></div><div><h5 class="text-xs font-bold text-slate-400 uppercase mb-1">Observation</h5><p class="text-sm text-slate-200 leading-relaxed">${text}</p></div>`;
                container.appendChild(card);
            });
        }
        function renderExplanation(response) {
            const container = document.getElementById('explainSteps');
            const textContainer = document.getElementById('aiExplainText');
            container.innerHTML = '';
            const steps = response.explanation?.steps || ["Processing..."];
            steps.forEach((step, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3";
                div.innerHTML = `<div class="w-6 h-6 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center text-[10px] font-mono text-slate-400 shrink-0">0${index+1}</div><div class="flex-1 h-[1px] bg-slate-800"></div><div class="text-xs font-mono text-cyan-200 flex-1 whitespace-nowrap">${step}</div><i class="fas fa-check-circle text-green-500 text-xs"></i>`;
                container.appendChild(div);
            });
            textContainer.innerText = response.nl_response && response.nl_response.trim() !== "" ? response.nl_response : (response.explanation?.narrative || "No explanation generated.");
        }
        function updateChartType(type) { currentChartType = type; if (lastAnalysisResult) renderVisuals(); }
        function generateMockResponse(goal, parsed) {
            const rows = parsed.data.length;
            let mock = { status: "success", rows_processed: rows, engine: "SIFRA_SIMULATION_KERNEL", explanation: { steps: ["Ingesting Data Stream...", `Applying Goal: ${goal.toUpperCase()}...`, "Running Statistical Validation...", "Finalizing Output Vectors..."], narrative: "Data ingestion complete. The system applied the selected operation successfully." } };
            if (goal === 'forecast') {
                const lastVal = typeof parsed.data[rows-1][1] === 'number' ? parsed.data[rows-1][1] : 100;
                mock.predictions = [{ step: 1, value: lastVal * 1.05 }, { step: 2, value: lastVal * 1.02 }, { step: 3, value: lastVal * 1.08 }, { step: 4, value: lastVal * 1.15 }, { step: 5, value: lastVal * 1.12 }];
                mock.insights = ["Upward trend detected in the next 5 intervals.", "Confidence interval narrows towards t+2, then expands."];
                mock.explanation.steps = ["Time-series index identified.", "Seasonality check: Positive.", "Applying NARE-X Forecasting Model..."];
            } else if (goal === 'anomaly') {
                mock.anomalies = [{ index: 8, score: 0.98, reason: "Spike > 3 std dev" }];
                mock.insights = ["1 Critical Anomaly detected at index 8.", "Data variance is stable outside of the detected outlier."];
                mock.explanation.steps = ["Calculating Distribution Metrics...", "Applying Z-Score Thresholding...", "1 Critical Anomaly Flagged."];
            } else if (goal === 'visualize') {
                mock.dashboard_config = { title: "Executive Overview", widgets: ["Trend Analysis"] };
                mock.insights = ["Interactive dashboard generated.", "Select specific regions to filter data."];
                mock.explanation.steps = ["Analyzing Data Topology...", "Selecting Optimal Chart Types...", "Rendering Visuals."];
            }
            return mock;
        }
    </script>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBu6CIgw5njjcl9dVhNYjitSUBKE87_S6M",
            authDomain: "sifraaiweb.firebaseapp.com",
            projectId: "sifraaiweb",
            storageBucket: "sifraaiweb.firebasestorage.app",
            messagingSenderId: "927713452336",
            appId: "1:927713452336:web:f3affb6ef66091619e68f5",
            measurementId: "G-V3TXBH3GCD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userUid = null;
        let userTier = 'recruit'; // Default to free

        // Auth Listener & UI Updates
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUid = user.uid;
                console.log("User authorized:", user.email);
                
                const displayName = user.displayName || user.email.split('@')[0].toUpperCase();
                const avatarUrl = user.photoURL;
                
                // Header Avatar
                const headerImg = document.getElementById('headerAvatar');
                const headerText = document.getElementById('headerInitials');
                
                if (avatarUrl) {
                    headerImg.src = avatarUrl;
                    headerImg.classList.remove('hidden');
                    headerText.classList.add('hidden');
                } else {
                    headerText.textContent = displayName.substring(0, 2).toUpperCase();
                    headerImg.classList.add('hidden');
                    headerText.classList.remove('hidden');
                }

                // Fetch Tier & Usage
                const planBadge = document.getElementById('planBadge');
                const userRef = doc(db, "users", user.uid);
                
                try {
                    const snap = await getDoc(userRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        userTier = data.subscriptionTier || 'recruit';
                        
                        // Ensure dailyUsage exists for today
                        const today = new Date().toDateString();
                        if (!data.dailyUsage || data.dailyUsage.date !== today) {
                            await setDoc(userRef, { dailyUsage: { date: today, count: 0 } }, { merge: true });
                        }
                    } else {
                        // First time login fallback
                        await setDoc(userRef, { 
                            email: user.email, 
                            subscriptionTier: 'recruit', 
                            dailyUsage: { date: new Date().toDateString(), count: 0 } 
                        });
                    }
                } catch(e) {
                    console.error("Profile fetch error", e);
                }

                planBadge.innerText = userTier.toUpperCase();
                if(userTier === 'commander' || userTier === 'titan') {
                    planBadge.classList.replace('text-slate-300', 'text-purple-400');
                    planBadge.classList.replace('border-slate-600', 'border-purple-500');
                }

                // Reveal main UI
                document.getElementById('appBody').style.opacity = '1';

            } else {
                console.warn("No active session. Redirecting...");
                window.location.href = 'login.html';
            }
        });

        // Global function to check usage limits before running
        window.checkLimit = async () => {
            if (!userUid) return false;
            // Commander/Titan have no limits
            if (userTier !== 'recruit') return true; 

            const userRef = doc(db, "users", userUid);
            const snap = await getDoc(userRef);
            const data = snap.data();
            const today = new Date().toDateString();
            
            // Check if usage matches today and exceeds limit
            if (data.dailyUsage && data.dailyUsage.date === today) {
                if (data.dailyUsage.count >= 3) {
                    alert("Daily Limit Reached (3/3).\n\nYou are on the Recruit plan. Please upgrade to Commander for unlimited access.");
                    return false;
                }
            }
            return true;
        };

        // Global function to increment usage after successful run
        window.incrementUsage = async () => {
            if (!userUid) return;
            
            const userRef = doc(db, "users", userUid);
            const snap = await getDoc(userRef);
            const data = snap.data();
            const today = new Date().toDateString();
            
            let newCount = 1;
            // If entry exists for today, increment. Else start at 1.
            if (data.dailyUsage && data.dailyUsage.date === today) {
                newCount = data.dailyUsage.count + 1;
            }
            
            await updateDoc(userRef, {
                dailyUsage: { date: today, count: newCount }
            });
            
            // Log visible feedback only for free tier users
            if (userTier === 'recruit') {
                const consoleLog = document.getElementById('consoleLog');
                const div = document.createElement('div');
                div.className = "console-line";
                div.innerHTML = `<span class="console-time">[sys]</span><span class="log-warn">Daily Usage: ${newCount}/3</span>`;
                consoleLog.appendChild(div);
                consoleLog.scrollTop = consoleLog.scrollHeight;
            }
        };
    </script>
</body>
</html>