<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIFRA AI | Identity Matrix</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBu6CIgw5njjcl9dVhNYjitSUBKE87_S6M",
            authDomain: "sifraaiweb.firebaseapp.com",
            projectId: "sifraaiweb",
            storageBucket: "sifraaiweb.firebasestorage.app",
            messagingSenderId: "927713452336",
            appId: "1:927713452336:web:f3affb6ef66091619e68f5",
            measurementId: "G-V3TXBH3GCD"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        sifra: {
                            bg: '#020617',
                            panel: '#0f172a',
                            border: '#1e293b',
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                            success: '#10b981'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .avatar-option {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        .avatar-option:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }
        .avatar-active {
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4) !important;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0.4;
        }

        .category-tab {
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .category-tab.active {
            border-color: #06b6d4;
            color: #06b6d4;
        }
    </style>
</head>
<body class="bg-sifra-bg text-slate-200 font-sans min-h-screen flex flex-col relative overflow-x-hidden bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">

    <canvas id="bg-canvas"></canvas>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-slate-950/80 backdrop-blur-md w-full px-6 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center text-white font-bold font-orbitron text-sm">S</div>
            <a href="home.html" class="text-lg font-orbitron font-bold text-white tracking-widest hover:text-cyan-400 transition-colors">SIFRA<span class="text-cyan-500">.AI</span></a>
        </div>
        <div class="flex items-center gap-4">
            <a href="home.html" class="text-xs font-mono text-slate-400 hover:text-white uppercase tracking-widest transition-colors">Command Center</a>
            <button onclick="handleLogout()" class="px-4 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 text-[10px] font-bold rounded border border-red-500/20 uppercase tracking-tighter">Disconnect</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-10 opacity-0 transition-opacity duration-700" id="profileContent">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left: Identity Overview -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-8 rounded-2xl relative overflow-hidden border-t-4 border-t-cyan-500 text-center">
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <div class="absolute inset-0 bg-cyan-500 blur-2xl opacity-20 animate-pulse"></div>
                        <img id="currentAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Base" alt="Identity" class="relative w-full h-full rounded-full border-4 border-slate-800 bg-slate-900 object-cover shadow-2xl">
                        <div class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 border-4 border-slate-900 rounded-full animate-pulse"></div>
                    </div>
                    
                    <h2 id="userName" class="text-2xl font-bold text-white font-orbitron tracking-tight">IDENTITY_LOCKED</h2>
                    <p id="userEmail" class="text-sm text-slate-400 font-mono mb-6">syncing_datalink...</p>
                    
                    <div class="space-y-3 pt-6 border-t border-white/5">
                        <div class="flex justify-between items-center text-[10px] uppercase font-bold tracking-widest">
                            <span class="text-slate-500">Protocol Tier</span>
                            <span id="displayTier" class="text-cyan-400">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px] uppercase font-bold tracking-widest">
                            <span class="text-slate-500">Grid Node</span>
                            <span id="displayNodeId" class="text-purple-400 font-mono">SFR-SYNC-X</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-xs font-bold text-white mb-4 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-shield-halved text-cyan-500"></i> Terminal Stats
                    </h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-slate-950/40 rounded-lg border border-white/5">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">Identity UID</p>
                            <code id="displayUid" class="text-[10px] text-slate-400 break-all font-mono">...</code>
                        </div>
                        <div class="p-3 bg-slate-950/40 rounded-lg border border-white/5">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">Last Synchronization</p>
                            <p id="lastLogin" class="text-[10px] text-slate-400 font-mono">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Identity Matrix (Avatar Selection) -->
            <div class="lg:col-span-8 space-y-6">
                <div class="glass-panel p-8 rounded-2xl">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                        <div>
                            <h3 class="text-xl font-orbitron font-bold text-white">IDENTITY MATRIX</h3>
                            <p class="text-xs text-slate-400 font-mono mt-1 uppercase tracking-tighter">Configure your visual presence across the neural grid</p>
                        </div>
                        
                        <div class="flex bg-slate-900/50 p-1 rounded-lg border border-white/5">
                            <button onclick="filterAvatars('mens')" id="btn-mens" class="category-tab px-4 py-1.5 text-[10px] font-bold uppercase active">Mens</button>
                            <button onclick="filterAvatars('womens')" id="btn-womens" class="category-tab px-4 py-1.5 text-[10px] font-bold uppercase">Womens</button>
                            <button onclick="filterAvatars('cartoons')" id="btn-cartoons" class="category-tab px-4 py-1.5 text-[10px] font-bold uppercase">Cartoons</button>
                        </div>
                    </div>

                    <div id="avatarGrid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4 min-h-[300px]">
                        <!-- Avatars loaded via JS -->
                    </div>

                    <div class="mt-8 pt-8 border-t border-white/5 flex justify-end">
                        <button id="saveIdentityBtn" onclick="saveNewIdentity()" disabled class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 disabled:opacity-30 disabled:cursor-not-allowed text-white font-bold text-xs rounded-lg font-orbitron tracking-widest shadow-lg shadow-cyan-500/20 transition-all uppercase">
                            Equip Identity
                        </button>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl border-l-4 border-l-purple-500">
                    <h3 class="text-xs font-bold text-purple-400 mb-2 uppercase tracking-widest">Grid Integration</h3>
                    <p class="text-sm text-slate-400 leading-relaxed font-mono">Your identity hash is encrypted and synced across all SIFRA AI nodes. Updating your visual profile will propagate to the Command Center immediately.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const AVATAR_DB = {
            mens: ['Jack', 'Felix', 'Rocky', 'Caleb', 'Victor', 'Leo', 'Max', 'Zane', 'Ivan', 'Grant'],
            womens: ['Aneka', 'Lily', 'Bella', 'Sassy', 'Maya', 'Nora', 'Jade', 'Luna', 'Cleo', 'Sara'],
            cartoons: ['Midnight', 'Shadow', 'Cyber', 'Ghost', 'Spark', 'Volt', 'Pixel', 'Sonic', 'Astro', 'Neo']
        };

        let selectedAvatarUrl = null;
        let currentUserData = null;

        // --- AUTH & SUBSCRIPTION SYNC ---
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = "login.html"; 
                return;
            }

            currentUserData = user;
            document.getElementById('profileContent').style.opacity = '1';
            
            // Populate basic info
            document.getElementById('userName').innerText = user.displayName || "IDENTIFIED";
            document.getElementById('userEmail').innerText = user.email;
            document.getElementById('displayUid').innerText = user.uid;
            document.getElementById('displayNodeId').innerText = `SFR-${user.uid.slice(0, 6).toUpperCase()}-X`;
            document.getElementById('lastLogin').innerText = new Date(user.metadata.lastSignInTime).toLocaleString();

            if (user.photoURL) {
                document.getElementById('currentAvatar').src = user.photoURL;
            }

            // Fetch Subscription Tier from Firestore
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    const tier = (data.tier || data.subscriptionTier || 'recruit').toUpperCase();
                    document.getElementById('displayTier').innerText = tier;
                    // Update username if callsign exists in DB
                    if(data.callsign) document.getElementById('userName').innerText = data.callsign.toUpperCase();
                } else {
                    document.getElementById('displayTier').innerText = 'UNAUTHORIZED';
                }
            } catch (err) {
                console.error("Firestore sync error:", err);
                document.getElementById('displayTier').innerText = 'SYNC_ERROR';
            }

            // Initial load of avatar grid
            filterAvatars('mens');
        });

        // --- IDENTITY MATRIX LOGIC ---
        function filterAvatars(category) {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active', 'text-cyan-400'));
            const activeTab = document.getElementById(`btn-${category}`);
            activeTab.classList.add('active', 'text-cyan-400');

            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';

            const collection = category === 'cartoons' ? 'bottts' : 'avataaars';
            
            AVATAR_DB[category].forEach(seed => {
                const url = `https://api.dicebear.com/7.x/${collection}/svg?seed=${seed}`;
                const div = document.createElement('div');
                div.className = `avatar-option glass-panel rounded-xl p-2 aspect-square flex items-center justify-center bg-slate-900/40`;
                div.innerHTML = `<img src="${url}" class="w-full h-full rounded-lg" loading="lazy">`;
                div.onclick = () => selectAvatar(url, div);
                grid.appendChild(div);
            });
        }

        function selectAvatar(url, element) {
            selectedAvatarUrl = url;
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('avatar-active'));
            element.classList.add('avatar-active');
            document.getElementById('saveIdentityBtn').disabled = false;
        }

        async function saveNewIdentity() {
            if (!selectedAvatarUrl || !currentUserData) return;

            const btn = document.getElementById('saveIdentityBtn');
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> SYNCING...`;
            btn.disabled = true;

            try {
                // 1. Update Firebase Auth Profile
                await currentUserData.updateProfile({ photoURL: selectedAvatarUrl });
                
                // 2. Update Firestore User Record
                await db.collection('users').doc(currentUserData.uid).set({
                    photoURL: selectedAvatarUrl,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // 3. UI feedback
                document.getElementById('currentAvatar').src = selectedAvatarUrl;
                btn.innerHTML = `<i class="fas fa-check"></i> EQUIPPED`;
                btn.classList.replace('bg-cyan-600', 'bg-green-600');

                setTimeout(() => {
                    btn.innerText = "Equip Identity";
                    btn.classList.replace('bg-green-600', 'bg-cyan-600');
                    btn.disabled = false;
                }, 2000);

            } catch (err) {
                console.error("Identity Sync Error:", err);
                btn.innerText = "Transmission Error";
                btn.disabled = false;
            }
        }

        function handleLogout() {
            auth.signOut().then(() => {
                window.location.href = "login.html";
            });
        }
    </script>

    <!-- Neural Background logic -->
    <script>
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.4;
                this.vy = (Math.random() - 0.5) * 0.4;
                this.size = Math.random() * 1.5;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if(this.x < 0 || this.x > width) this.vx *= -1;
                if(this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(100, 116, 139, 0.4)';
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function init() {
            resize();
            particles = Array.from({length: 40}, () => new Particle());
        }

        function animate() {
            ctx.clearRect(0,0,width,height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', init);
        init();
        animate();
    </script>
</body>
</html>